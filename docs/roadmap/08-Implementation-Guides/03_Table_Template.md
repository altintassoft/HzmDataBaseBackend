# üìã Table Template

> **Her tablo i√ßin standart template - Copy-paste ready!**

[‚óÄÔ∏è Geri: Roadmap & Tech Stack](11_Roadmap_TechStack.md) | [Ana Sayfa](README.md)

---

## üìã ƒ∞√ßindekiler

1. [Standard Table Template](#standard-table-template)
2. [Kritik Noktalar](#kritik-noktalar)
3. [√ñrnek Kullanƒ±m](#√∂rnek-kullanƒ±m)
4. [Checklist](#checklist)

---

## Standard Table Template

### Tam Template (Copy-Paste!)

```sql
-- üî• B√úT√úN MULTI-TENANT TABLOLARDA OLMASI GEREKENLER
CREATE TABLE {schema}.{table_name} (
  -- Primary Key (Modern PostgreSQL!)
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  
  -- Multi-tenancy (MUTLAKA!)
  tenant_id INTEGER NOT NULL REFERENCES core.tenants(id),
  
  -- ============================================
  -- YOUR BUSINESS COLUMNS HERE
  -- ============================================
  
  -- Text fields
  -- name VARCHAR(200) NOT NULL,
  -- description TEXT,
  
  -- Email (case-insensitive!)
  -- email citext UNIQUE NOT NULL,
  
  -- Numbers
  -- price NUMERIC(12,2) NOT NULL,
  -- quantity INTEGER DEFAULT 0,
  
  -- Boolean
  -- is_featured BOOLEAN DEFAULT FALSE,
  
  -- Dates
  -- published_at TIMESTAMPTZ,
  
  -- JSON
  -- metadata JSONB DEFAULT '{}'::jsonb,
  -- settings JSONB DEFAULT '{}'::jsonb,
  
  -- Arrays
  -- tags TEXT[] DEFAULT '{}',
  
  -- Foreign keys
  -- category_id INTEGER REFERENCES {schema}.categories(id),
  -- user_id INTEGER NOT NULL REFERENCES core.users(id),
  
  -- ============================================
  -- STANDARD COLUMNS (Deƒüi≈ütirme!)
  -- ============================================
  
  -- Data Integrity
  is_active BOOLEAN DEFAULT TRUE,
  is_deleted BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMPTZ,
  deleted_by INTEGER REFERENCES core.users(id),
  
  -- Optimistic Locking
  version INTEGER DEFAULT 1,
  
  -- Timestamps (TIMESTAMPTZ!)
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  
  -- Audit
  created_by INTEGER REFERENCES core.users(id),
  updated_by INTEGER REFERENCES core.users(id)
);

-- ============================================
-- INDEXES (MUTLAKA!)
-- ============================================

-- Primary tenant index (HER TABLODA!)
CREATE INDEX idx_{table}_tenant ON {schema}.{table}(tenant_id);

-- Active records (Sƒ±k kullanƒ±lƒ±r)
CREATE INDEX idx_{table}_active ON {schema}.{table}(tenant_id) 
  WHERE is_active = TRUE AND is_deleted = FALSE;

-- Created date (Sorting i√ßin)
CREATE INDEX idx_{table}_created ON {schema}.{table}(created_at);

-- Foreign keys (ƒ∞htiya√ß varsa)
-- CREATE INDEX idx_{table}_user ON {schema}.{table}(user_id);
-- CREATE INDEX idx_{table}_category ON {schema}.{table}(category_id);

-- Composite indexes (Birlikte arananlar)
-- CREATE INDEX idx_{table}_composite ON {schema}.{table}(tenant_id, status, created_at);

-- Unique constraints (tenant bazlƒ±)
-- ALTER TABLE {schema}.{table} ADD CONSTRAINT unique_{table}_name 
--   UNIQUE (tenant_id, name);

-- ============================================
-- TRIGGERS (MUTLAKA!)
-- ============================================

-- 1. Auto-update updated_at + version
CREATE TRIGGER trg_{table}_touch 
  BEFORE UPDATE ON {schema}.{table} 
  FOR EACH ROW EXECUTE FUNCTION app.touch_row();

-- 2. Soft delete (DELETE ‚Üí UPDATE)
CREATE TRIGGER trg_{table}_softdel 
  BEFORE DELETE ON {schema}.{table} 
  FOR EACH ROW EXECUTE FUNCTION app.soft_delete();

-- 3. Audit log (Her deƒüi≈üikliƒüi kaydet)
CREATE TRIGGER trg_{table}_audit 
  AFTER INSERT OR UPDATE OR DELETE ON {schema}.{table} 
  FOR EACH ROW EXECUTE FUNCTION ops.log_audit();

-- ============================================
-- ROW LEVEL SECURITY (MUTLAKA!)
-- ============================================

-- RLS aktif et
ALTER TABLE {schema}.{table} ENABLE ROW LEVEL SECURITY;

-- Tenant policy (Normal users)
CREATE POLICY rls_{table}_tenant ON {schema}.{table}
  USING (tenant_id = app.current_tenant())
  WITH CHECK (tenant_id = app.current_tenant());

-- Platform admin policy (Opsiyonel)
CREATE POLICY rls_{table}_admin ON {schema}.{table}
  USING (
    EXISTS (
      SELECT 1 FROM core.users 
      WHERE id = app.current_user_id() AND role = 'platform_admin'
    )
  );
```

---

## Kritik Noktalar

### ‚úÖ MUTLAKA Kullan

1. **`GENERATED BY DEFAULT AS IDENTITY`** (SERIAL deƒüil!)
   ```sql
   id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY  -- ‚úÖ Modern
   id SERIAL PRIMARY KEY  -- ‚ùå Eski
   ```

2. **`TIMESTAMPTZ`** (TIMESTAMP deƒüil!)
   ```sql
   created_at TIMESTAMPTZ  -- ‚úÖ Timezone aware
   created_at TIMESTAMP    -- ‚ùå Timezone yok
   ```

3. **`citext`** (Email i√ßin)
   ```sql
   email citext UNIQUE NOT NULL  -- ‚úÖ Case-insensitive
   email VARCHAR(255)            -- ‚ùå Case-sensitive
   ```

4. **`JSONB DEFAULT '{}'::jsonb`** (Explicit cast)
   ```sql
   settings JSONB DEFAULT '{}'::jsonb  -- ‚úÖ Type safe
   settings JSONB DEFAULT '{}'         -- ‚ö†Ô∏è Ambiguous
   ```

5. **Schema prefix**
   ```sql
   CREATE TABLE core.users (...)  -- ‚úÖ Schema var
   CREATE TABLE users (...)       -- ‚ùå Public schema
   ```

6. **3 Trigger** (touch, softdel, audit)
   ```sql
   CREATE TRIGGER trg_{table}_touch ...    -- ‚úÖ
   CREATE TRIGGER trg_{table}_softdel ...  -- ‚úÖ
   CREATE TRIGGER trg_{table}_audit ...    -- ‚úÖ
   ```

7. **RLS** (Enabled + 2 policy)
   ```sql
   ALTER TABLE {table} ENABLE ROW LEVEL SECURITY;  -- ‚úÖ
   CREATE POLICY rls_{table}_tenant ...            -- ‚úÖ
   CREATE POLICY rls_{table}_admin ...             -- ‚úÖ
   ```

### ‚ùå YAPMA

1. **`SERIAL` kullanma**
   ```sql
   id SERIAL PRIMARY KEY  -- ‚ùå Eski
   ```

2. **`TIMESTAMP` kullanma**
   ```sql
   created_at TIMESTAMP  -- ‚ùå Timezone yok
   ```

3. **`tenant_id` eksik**
   ```sql
   CREATE TABLE products (id, name, price);  -- ‚ùå tenant_id nerede?
   ```

4. **Index eksik**
   ```sql
   -- ‚ùå Index yok
   SELECT * FROM products WHERE tenant_id = $1;  -- Yava≈ü!
   ```

5. **Trigger eksik**
   ```sql
   -- ‚ùå Trigger yok
   UPDATE products SET name = 'New', updated_at = now();  -- Manuel!
   ```

6. **RLS eksik**
   ```sql
   -- ‚ùå RLS yok
   SELECT * FROM products WHERE tenant_id = $1;  -- Developer'a baƒülƒ±!
   ```

---

## √ñrnek Kullanƒ±m

### √ñrnek 1: Products Tablosu

```sql
CREATE TABLE core.products (
  -- PK
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INTEGER NOT NULL REFERENCES core.tenants(id),
  
  -- Business columns
  name VARCHAR(200) NOT NULL,
  description TEXT,
  sku VARCHAR(100),
  price NUMERIC(12,2) NOT NULL,
  currency VARCHAR(3) REFERENCES cfg.currencies(code) DEFAULT 'USD',
  stock INTEGER DEFAULT 0,
  images JSONB DEFAULT '[]'::jsonb,
  is_featured BOOLEAN DEFAULT FALSE,
  category_id INTEGER REFERENCES core.categories(id),
  
  -- Standard columns
  is_active BOOLEAN DEFAULT TRUE,
  is_deleted BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMPTZ,
  deleted_by INTEGER REFERENCES core.users(id),
  version INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  created_by INTEGER REFERENCES core.users(id),
  updated_by INTEGER REFERENCES core.users(id),
  
  -- Constraints
  CONSTRAINT unique_sku_per_tenant UNIQUE (tenant_id, sku),
  CONSTRAINT check_price_positive CHECK (price >= 0),
  CONSTRAINT check_stock_positive CHECK (stock >= 0)
);

-- Indexes
CREATE INDEX idx_products_tenant ON core.products(tenant_id);
CREATE INDEX idx_products_active ON core.products(tenant_id) 
  WHERE is_active = TRUE AND is_deleted = FALSE;
CREATE INDEX idx_products_category ON core.products(category_id);
CREATE INDEX idx_products_featured ON core.products(tenant_id, is_featured) 
  WHERE is_featured = TRUE AND is_deleted = FALSE;

-- Triggers
CREATE TRIGGER trg_products_touch 
  BEFORE UPDATE ON core.products 
  FOR EACH ROW EXECUTE FUNCTION app.touch_row();

CREATE TRIGGER trg_products_softdel 
  BEFORE DELETE ON core.products 
  FOR EACH ROW EXECUTE FUNCTION app.soft_delete();

CREATE TRIGGER trg_products_audit 
  AFTER INSERT OR UPDATE OR DELETE ON core.products 
  FOR EACH ROW EXECUTE FUNCTION ops.log_audit();

-- RLS
ALTER TABLE core.products ENABLE ROW LEVEL SECURITY;

CREATE POLICY rls_products_tenant ON core.products
  USING (tenant_id = app.current_tenant())
  WITH CHECK (tenant_id = app.current_tenant());

CREATE POLICY rls_products_admin ON core.products
  USING (
    EXISTS (
      SELECT 1 FROM core.users 
      WHERE id = app.current_user_id() AND role = 'platform_admin'
    )
  );
```

### √ñrnek 2: Orders Tablosu

```sql
CREATE TABLE core.orders (
  -- PK
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INTEGER NOT NULL REFERENCES core.tenants(id),
  
  -- Business columns
  order_number VARCHAR(50) UNIQUE NOT NULL,
  customer_id INTEGER NOT NULL REFERENCES core.customers(id),
  status VARCHAR(50) DEFAULT 'pending',  -- pending, paid, shipped, delivered, cancelled
  
  -- Money
  subtotal NUMERIC(12,2) NOT NULL,
  tax NUMERIC(12,2) DEFAULT 0,
  shipping NUMERIC(12,2) DEFAULT 0,
  discount NUMERIC(12,2) DEFAULT 0,
  total NUMERIC(12,2) NOT NULL,
  currency VARCHAR(3) REFERENCES cfg.currencies(code) DEFAULT 'USD',
  
  -- Addresses
  shipping_address JSONB,
  billing_address JSONB,
  
  -- Payment
  payment_method VARCHAR(50),
  payment_status VARCHAR(50) DEFAULT 'pending',
  paid_at TIMESTAMPTZ,
  
  -- Shipping
  shipped_at TIMESTAMPTZ,
  delivered_at TIMESTAMPTZ,
  tracking_number VARCHAR(100),
  
  -- Notes
  customer_note TEXT,
  internal_note TEXT,
  
  -- Standard columns
  is_active BOOLEAN DEFAULT TRUE,
  is_deleted BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMPTZ,
  deleted_by INTEGER REFERENCES core.users(id),
  version INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  created_by INTEGER REFERENCES core.users(id),
  updated_by INTEGER REFERENCES core.users(id)
);

-- Indexes
CREATE INDEX idx_orders_tenant ON core.orders(tenant_id);
CREATE INDEX idx_orders_customer ON core.orders(customer_id);
CREATE INDEX idx_orders_status ON core.orders(tenant_id, status);
CREATE INDEX idx_orders_created ON core.orders(created_at);
CREATE INDEX idx_orders_number ON core.orders(order_number);

-- Triggers
CREATE TRIGGER trg_orders_touch 
  BEFORE UPDATE ON core.orders 
  FOR EACH ROW EXECUTE FUNCTION app.touch_row();

CREATE TRIGGER trg_orders_softdel 
  BEFORE DELETE ON core.orders 
  FOR EACH ROW EXECUTE FUNCTION app.soft_delete();

CREATE TRIGGER trg_orders_audit 
  AFTER INSERT OR UPDATE OR DELETE ON core.orders 
  FOR EACH ROW EXECUTE FUNCTION ops.log_audit();

-- RLS
ALTER TABLE core.orders ENABLE ROW LEVEL SECURITY;

CREATE POLICY rls_orders_tenant ON core.orders
  USING (tenant_id = app.current_tenant())
  WITH CHECK (tenant_id = app.current_tenant());
```

---

## Checklist

### Her Tablo Olu≈ütururken

- [ ] `CREATE TABLE {schema}.{table}` (schema prefix var mƒ±?)
- [ ] `id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY` (Modern PK?)
- [ ] `tenant_id INTEGER NOT NULL REFERENCES core.tenants(id)` (Multi-tenancy?)
- [ ] Business columns (Domain-specific alanlar)
- [ ] `is_active`, `is_deleted`, `deleted_at`, `deleted_by` (Soft delete?)
- [ ] `version` (Optimistic locking?)
- [ ] `created_at`, `updated_at` (TIMESTAMPTZ?)
- [ ] `created_by`, `updated_by` (Audit?)
- [ ] `CREATE INDEX idx_{table}_tenant ON {table}(tenant_id)` (Tenant index?)
- [ ] `CREATE INDEX idx_{table}_active ON {table}(tenant_id) WHERE ...` (Active index?)
- [ ] `CREATE TRIGGER trg_{table}_touch ...` (Touch trigger?)
- [ ] `CREATE TRIGGER trg_{table}_softdel ...` (Soft delete trigger?)
- [ ] `CREATE TRIGGER trg_{table}_audit ...` (Audit trigger?)
- [ ] `ALTER TABLE {table} ENABLE ROW LEVEL SECURITY` (RLS enabled?)
- [ ] `CREATE POLICY rls_{table}_tenant ...` (Tenant policy?)
- [ ] `CREATE POLICY rls_{table}_admin ...` (Admin policy - opsiyonel)

### Code Review Checklist

- [ ] **PK type:** `GENERATED BY DEFAULT AS IDENTITY` ‚úÖ (SERIAL ‚ùå)
- [ ] **Timestamps:** `TIMESTAMPTZ` ‚úÖ (TIMESTAMP ‚ùå)
- [ ] **Email:** `citext` ‚úÖ (VARCHAR ‚ùå)
- [ ] **tenant_id:** Var mƒ±? Index var mƒ±?
- [ ] **Soft delete:** `is_deleted`, `deleted_at`, `deleted_by` var mƒ±?
- [ ] **Optimistic lock:** `version` var mƒ±?
- [ ] **Audit:** `created_by`, `updated_by` var mƒ±?
- [ ] **Indexes:** `tenant_id`, foreign keys, sƒ±k aranan kolonlar
- [ ] **3 Trigger:** touch, softdel, audit
- [ ] **RLS:** Enabled + 2 policy (tenant + admin)
- [ ] **JSONB:** Explicit cast `'{}'::jsonb` var mƒ±?
- [ ] **Constraints:** UNIQUE, CHECK constraints doƒüru mu?

---

## üîó ƒ∞lgili D√∂k√ºmanlar

- [01_PostgreSQL_Setup.md](01_PostgreSQL_Setup.md) - Trigger functions
- [02_Core_Database_Schema.md](02_Core_Database_Schema.md) - √ñrnek tablolar
- [04_RLS_Multi_Tenant_Strategy.md](04_RLS_Multi_Tenant_Strategy.md) - RLS policies
- [09_Implementation_Checklist.md](09_Implementation_Checklist.md) - P0 features
- [10_Common_Mistakes.md](10_Common_Mistakes.md) - Yaygƒ±n hatalar

---

**Versiyon:** 1.0.0  
**Tarih:** Ekim 2025  
**Yazar:** HZM Development Team

---

**[‚óÄÔ∏è Geri: Roadmap & Tech Stack](11_Roadmap_TechStack.md) | [Ana Sayfa](README.md)**


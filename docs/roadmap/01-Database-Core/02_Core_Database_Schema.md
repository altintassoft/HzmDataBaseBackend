# üóÑÔ∏è Core Database Schema

> **Core platform tablolarƒ±: Users, Tenants, Projects, Table Metadata, API Keys**

[‚óÄÔ∏è Geri: PostgreSQL Setup](01_PostgreSQL_Setup.md) | [Ana Sayfa](README.md) | [ƒ∞leri: i18n Tables ‚ñ∂Ô∏è](03_i18n_Tables.md)

---

## üìã ƒ∞√ßindekiler

‚ö†Ô∏è **UYARI: Tablo olu≈üturma sƒ±rasƒ± kritik! A≈üaƒüƒ±daki sƒ±rayƒ± takip edin:**
> Detaylƒ± dependency chain i√ßin: [Migration Order Guide](../15-Database-Migrations/00_MIGRATION_ORDER.md)

1. [core.tenants - M√º≈üteri ƒ∞zolasyonu](#1-coretenants---m√º≈üteri-iÃázolasyonu) ‚Üê **ƒ∞LK √ñNCE!**
2. [core.users - Kullanƒ±cƒ±lar](#2-coreusers---kullanƒ±cƒ±lar) ‚Üê tenants'a baƒülƒ±
3. [core.projects - Tenant Projeleri](#3-coreprojects---tenant-projeleri) ‚Üê users'a baƒülƒ±
4. [core.table_metadata - Dinamik Tablolar](#4-coretable_metadata---dinamik-tablolar) ‚Üê projects'e baƒülƒ±
5. [**app.generic_data - Generic Table Pattern** ‚≠ê](#5-appgeneric_data---generic-table-pattern-) ‚Üê table_metadata'ya baƒülƒ±
6. [core.api_keys - API Eri≈üim Kontrol√º](#6-coreapi_keys---api-eri≈üim-kontrol√º) ‚Üê users'a baƒülƒ±

---

## 1. core.tenants - M√º≈üteri ƒ∞zolasyonu

> **üéØ Bu tablo ƒ∞LK √ñNCE olu≈üturulmalƒ±!** √á√ºnk√º `core.users`, `core.projects`, `core.api_keys` hepsi `tenant_id` ile baƒülƒ±.

### Tablo Tanƒ±mƒ±

```sql
CREATE TABLE core.tenants (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  
  -- Basic Info
  name VARCHAR(200) NOT NULL,
  slug VARCHAR(100) UNIQUE NOT NULL,  -- 'acme-corp', 'startup-x'
  domain VARCHAR(255) UNIQUE,  -- Custom domain (optional)
  
  -- Branding
  logo_url VARCHAR(500),
  favicon_url VARCHAR(500),
  primary_color VARCHAR(7),  -- Hex color: #FF5733
  secondary_color VARCHAR(7),
  
  -- üåç Internationalization (i18n)
  default_language VARCHAR(10) REFERENCES cfg.languages(code) DEFAULT 'en',
  supported_languages TEXT[] DEFAULT '{en}',
  timezone VARCHAR(50) DEFAULT 'UTC',
  date_format VARCHAR(20) DEFAULT 'YYYY-MM-DD',
  time_format VARCHAR(20) DEFAULT 'HH:mm:ss',
  
  -- üí∞ Currency & Financial
  default_currency VARCHAR(3) REFERENCES cfg.currencies(code) DEFAULT 'USD',
  supported_currencies TEXT[] DEFAULT '{USD}',
  auto_convert_currency BOOLEAN DEFAULT FALSE,
  decimal_separator VARCHAR(1) DEFAULT '.',
  thousands_separator VARCHAR(1) DEFAULT ',',
  
  -- Features & Limits
  features JSONB DEFAULT '{}'::jsonb,
  limits JSONB DEFAULT '{}'::jsonb,
  plan VARCHAR(50) DEFAULT 'free',
  subscription_status VARCHAR(20) DEFAULT 'active',
  trial_ends_at TIMESTAMPTZ,
  subscription_ends_at TIMESTAMPTZ,
  
  -- üö¶ Generic Table Pattern Limits
  max_projects INTEGER DEFAULT 3,
  max_tables_per_project INTEGER DEFAULT 10,
  max_records INTEGER DEFAULT 10000,
  
  -- Settings
  settings JSONB DEFAULT '{}'::jsonb,
  
  -- Status
  is_active BOOLEAN DEFAULT TRUE,
  is_deleted BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMPTZ,
  deleted_by INTEGER,
  
  -- Audit
  version INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE INDEX idx_tenants_slug ON core.tenants(slug);
CREATE INDEX idx_tenants_active ON core.tenants(is_active) WHERE is_deleted = FALSE;

-- Triggers
CREATE TRIGGER trg_tenants_touch 
  BEFORE UPDATE ON core.tenants 
  FOR EACH ROW EXECUTE FUNCTION app.touch_row();

CREATE TRIGGER trg_tenants_softdel 
  BEFORE DELETE ON core.tenants 
  FOR EACH ROW EXECUTE FUNCTION app.soft_delete();

CREATE TRIGGER trg_tenants_audit 
  AFTER INSERT OR UPDATE OR DELETE ON core.tenants 
  FOR EACH ROW EXECUTE FUNCTION ops.log_audit();
```

### Plan T√ºrleri (plan)

| Plan | A√ßƒ±klama | Limits √ñrneƒüi |
|------|----------|---------------|
| `free` | √úcretsiz | `max_projects: 3, max_records: 10000` |
| `starter` | Ba≈ülangƒ±√ß | `max_projects: 10, max_records: 100000` |
| `professional` | Profesyonel | `max_projects: 50, max_records: 1000000` |
| `enterprise` | Kurumsal | `max_projects: unlimited, max_records: unlimited` |

### Subscription Status

| Status | A√ßƒ±klama |
|--------|----------|
| `active` | Aktif abonelik |
| `trialing` | Deneme s√ºr√ºm√º |
| `past_due` | √ñdeme gecikti |
| `canceled` | ƒ∞ptal edildi |
| `unpaid` | √ñdenmedi |

---

## 2. core.users - Kullanƒ±cƒ±lar

> **‚ö†Ô∏è Bu tablo `core.tenants` SONRA olu≈üturulmalƒ±!** √á√ºnk√º `tenant_id REFERENCES core.tenants(id)`

### Tablo Tanƒ±mƒ±

```sql
CREATE TABLE core.users (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INTEGER NOT NULL REFERENCES core.tenants(id),
  
  -- Auth
  email citext UNIQUE NOT NULL,  -- Case-insensitive!
  password_hash VARCHAR(255) NOT NULL,
  email_verified BOOLEAN DEFAULT FALSE,
  email_verification_token VARCHAR(255),
  phone VARCHAR(50),
  phone_verified BOOLEAN DEFAULT FALSE,
  
  -- Profile
  name VARCHAR(200),
  role VARCHAR(50) DEFAULT 'user',  -- 'user', 'admin', 'tenant_owner', 'platform_admin'
  timezone VARCHAR(50) DEFAULT 'UTC',
  
  -- Status
  is_active BOOLEAN DEFAULT TRUE,
  is_deleted BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMPTZ,
  deleted_by INTEGER,
  
  -- Audit
  last_login_at TIMESTAMPTZ,
  login_count INTEGER DEFAULT 0,
  version INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  created_by INTEGER,
  updated_by INTEGER
);

-- Indexes
CREATE INDEX idx_users_tenant ON core.users(tenant_id);
CREATE INDEX idx_users_email ON core.users(email);
CREATE INDEX idx_users_active ON core.users(tenant_id) 
  WHERE is_active = TRUE AND is_deleted = FALSE;

-- Triggers
CREATE TRIGGER trg_users_touch 
  BEFORE UPDATE ON core.users 
  FOR EACH ROW EXECUTE FUNCTION app.touch_row();

CREATE TRIGGER trg_users_softdel 
  BEFORE DELETE ON core.users 
  FOR EACH ROW EXECUTE FUNCTION app.soft_delete();

CREATE TRIGGER trg_users_audit 
  AFTER INSERT OR UPDATE OR DELETE ON core.users 
  FOR EACH ROW EXECUTE FUNCTION ops.log_audit();

-- RLS (Row Level Security)
ALTER TABLE core.users ENABLE ROW LEVEL SECURITY;

CREATE POLICY rls_users_tenant ON core.users
  USING (tenant_id = app.current_tenant())
  WITH CHECK (tenant_id = app.current_tenant());

-- Platform admin'ler t√ºm kullanƒ±cƒ±larƒ± g√∂rebilir
CREATE POLICY rls_users_platform_admin ON core.users
  USING (
    EXISTS (
      SELECT 1 FROM core.users 
      WHERE id = app.current_user_id() AND role = 'platform_admin'
    )
  );
```

### √ñnemli Deƒüi≈üiklikler

| √ñzellik | Eski | Yeni | Neden? |
|---------|------|------|--------|
| ID type | `SERIAL` | `GENERATED BY DEFAULT AS IDENTITY` | Modern PostgreSQL standard |
| Email type | `VARCHAR(255)` | `citext` | Case-insensitive (user@test.com = USER@TEST.COM) |
| Timestamps | `TIMESTAMP` | `TIMESTAMPTZ` | Timezone aware |
| Soft delete | ‚ùå Yok | `is_deleted`, `deleted_at`, `deleted_by` | Veri geri getirilebilir |
| Optimistic locking | ‚ùå Yok | `version` | Race condition √∂nleme |
| Audit | ‚ùå Yok | `created_by`, `updated_by` | Kim olu≈üturdu/g√ºncelledi? |
| RLS | ‚ùå Yok | `ENABLE ROW LEVEL SECURITY` | Otomatik tenant izolasyonu |

### Roller (role)

| Role | A√ßƒ±klama | ƒ∞zinler |
|------|----------|---------|
| `user` | Normal kullanƒ±cƒ± | Sadece kendi verilerine eri≈üim |
| `admin` | Tenant admin | Tenant i√ßindeki t√ºm verilere eri≈üim |
| `tenant_owner` | Tenant sahibi | Billing, subscription y√∂netimi |
| `platform_admin` | Platform y√∂neticisi | T√ºm tenant'lara eri≈üim |

---

## 2. core.tenants - M√º≈üteri ƒ∞zolasyonu

### Tablo Tanƒ±mƒ±

```sql
CREATE TABLE core.tenants (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  
  -- Basic Info
  name VARCHAR(200) NOT NULL,
  slug VARCHAR(100) UNIQUE NOT NULL,  -- 'acme-corp', 'startup-x'
  domain VARCHAR(255) UNIQUE,  -- Custom domain (optional)
  
  -- Branding
  logo_url VARCHAR(500),
  favicon_url VARCHAR(500),
  primary_color VARCHAR(7),  -- Hex color: #FF5733
  secondary_color VARCHAR(7),
  
  -- üåç Internationalization (i18n)
  default_language VARCHAR(10) REFERENCES cfg.languages(code) DEFAULT 'en',
  supported_languages TEXT[] DEFAULT '{en}',
  timezone VARCHAR(50) DEFAULT 'UTC',
  date_format VARCHAR(20) DEFAULT 'YYYY-MM-DD',
  time_format VARCHAR(20) DEFAULT 'HH:mm:ss',
  
  -- üí∞ Currency & Financial
  default_currency VARCHAR(3) REFERENCES cfg.currencies(code) DEFAULT 'USD',
  supported_currencies TEXT[] DEFAULT '{USD}',
  auto_convert_currency BOOLEAN DEFAULT FALSE,
  decimal_separator VARCHAR(1) DEFAULT '.',
  thousands_separator VARCHAR(1) DEFAULT ',',
  
  -- Features & Limits
  features JSONB DEFAULT '{}'::jsonb,
  limits JSONB DEFAULT '{}'::jsonb,
  
  -- Subscription
  plan VARCHAR(50) DEFAULT 'free',  -- 'free', 'starter', 'pro', 'enterprise'
  subscription_status VARCHAR(20) DEFAULT 'active',
  trial_ends_at TIMESTAMPTZ,
  subscription_ends_at TIMESTAMPTZ,
  max_projects INTEGER DEFAULT 3,
  max_tables_per_project INTEGER DEFAULT 10,
  max_records INTEGER DEFAULT 10000,
  
  -- Settings
  settings JSONB DEFAULT '{}'::jsonb,
  
  -- Status
  is_active BOOLEAN DEFAULT TRUE,
  is_deleted BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMPTZ,
  deleted_by INTEGER,
  
  -- Audit
  version INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE INDEX idx_tenants_slug ON core.tenants(slug);
CREATE INDEX idx_tenants_language ON core.tenants(default_language);
CREATE INDEX idx_tenants_currency ON core.tenants(default_currency);
CREATE INDEX idx_tenants_active ON core.tenants(is_active) 
  WHERE is_deleted = FALSE;

-- Triggers
CREATE TRIGGER trg_tenants_touch 
  BEFORE UPDATE ON core.tenants 
  FOR EACH ROW EXECUTE FUNCTION app.touch_row();

CREATE TRIGGER trg_tenants_softdel 
  BEFORE DELETE ON core.tenants 
  FOR EACH ROW EXECUTE FUNCTION app.soft_delete();

CREATE TRIGGER trg_tenants_audit 
  AFTER INSERT OR UPDATE OR DELETE ON core.tenants 
  FOR EACH ROW EXECUTE FUNCTION ops.log_audit();
```

### Features & Limits (JSONB)

```json
// features √∂rneƒüi
{
  "api_access": true,
  "custom_domain": true,
  "white_labeling": false,
  "advanced_analytics": true,
  "webhooks": true,
  "sso": false
}

// limits √∂rneƒüi
{
  "max_api_calls_per_month": 100000,
  "max_storage_gb": 50,
  "max_team_members": 10,
  "max_concurrent_connections": 100
}
```

### Subscription Plans

| Plan | Max Projects | Tables/Project | Records | API Calls/day | Price |
|------|-------------|----------------|---------|---------------|-------|
| free | 1 | 5 | 1,000 | 1,000 | $0 |
| starter | 5 | 20 | 50,000 | 50,000 | $29 |
| pro | 25 | 100 | 500,000 | 500,000 | $99 |
| enterprise | Unlimited | Unlimited | Unlimited | Unlimited | Custom |

---

## 3. core.projects - Tenant Projeleri

### Tablo Tanƒ±mƒ±

```sql
CREATE TABLE core.projects (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INTEGER NOT NULL REFERENCES core.tenants(id) ON DELETE CASCADE,
  user_id INTEGER NOT NULL REFERENCES core.users(id) ON DELETE CASCADE,
  
  -- Project Info
  name VARCHAR(200) NOT NULL,
  description TEXT,
  
  -- Template (opsiyonel)
  template_type VARCHAR(100),  -- 'ecommerce', 'ridesharing', 'mlm', 'logistics'
  template_config JSONB DEFAULT '{}'::jsonb,
  
  -- API Keys
  api_key VARCHAR(100) UNIQUE NOT NULL,
  api_key_password VARCHAR(255),
  
  -- Status
  is_active BOOLEAN DEFAULT TRUE,
  is_deleted BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMPTZ,
  deleted_by INTEGER,
  
  -- Audit
  version INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  created_by INTEGER,
  updated_by INTEGER,
  
  CONSTRAINT unique_project_name_per_tenant UNIQUE (tenant_id, name)
);

-- Indexes
CREATE INDEX idx_projects_tenant ON core.projects(tenant_id);
CREATE INDEX idx_projects_user ON core.projects(user_id);
CREATE INDEX idx_projects_api_key ON core.projects(api_key);
CREATE INDEX idx_projects_template ON core.projects(template_type);
CREATE INDEX idx_projects_active ON core.projects(tenant_id) 
  WHERE is_active = TRUE AND is_deleted = FALSE;

-- Triggers
CREATE TRIGGER trg_projects_touch 
  BEFORE UPDATE ON core.projects 
  FOR EACH ROW EXECUTE FUNCTION app.touch_row();

CREATE TRIGGER trg_projects_softdel 
  BEFORE DELETE ON core.projects 
  FOR EACH ROW EXECUTE FUNCTION app.soft_delete();

CREATE TRIGGER trg_projects_audit 
  AFTER INSERT OR UPDATE OR DELETE ON core.projects 
  FOR EACH ROW EXECUTE FUNCTION ops.log_audit();

-- RLS
ALTER TABLE core.projects ENABLE ROW LEVEL SECURITY;

CREATE POLICY rls_projects_tenant ON core.projects
  USING (tenant_id = app.current_tenant())
  WITH CHECK (tenant_id = app.current_tenant());
```

### Template Types

| Template Type | A√ßƒ±klama | Tablolar |
|---------------|----------|----------|
| `ecommerce` | E-ticaret | Products, Orders, Customers, Cart |
| `ridesharing` | Ride-sharing | Drivers, Passengers, Rides, Vehicles |
| `mlm` | Network Marketing | Distributors, Commissions, Hierarchy |
| `logistics` | Lojistik | Shipments, Tracking, Warehouses |
| `crm` | CRM | Leads, Contacts, Opportunities |
| `ai` | AI/ML | Conversations, Messages, Models |

---

## 4. core.table_metadata - Dinamik Tablolar

### Tablo Tanƒ±mƒ±

```sql
CREATE TABLE core.table_metadata (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INTEGER NOT NULL REFERENCES core.tenants(id) ON DELETE CASCADE,
  project_id INTEGER NOT NULL REFERENCES core.projects(id) ON DELETE CASCADE,
  
  -- Table Info
  table_name VARCHAR(100) NOT NULL,  -- User-friendly name: "Products"
  physical_table_name VARCHAR(255) NOT NULL UNIQUE,  -- Actual table: "tenant_123_project_456_products_789"
  
  -- Schema (JSONB)
  fields JSONB NOT NULL DEFAULT '[]'::jsonb,
  
  -- Template Info (eƒüer template'ten geliyorsa)
  from_template BOOLEAN DEFAULT FALSE,
  template_table_name VARCHAR(100),
  
  -- Status
  is_active BOOLEAN DEFAULT TRUE,
  is_deleted BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMPTZ,
  deleted_by INTEGER,
  
  -- Audit
  version INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  created_by INTEGER,
  updated_by INTEGER,
  
  CONSTRAINT unique_table_per_project UNIQUE (tenant_id, project_id, table_name)
);

-- Indexes
CREATE INDEX idx_table_metadata_tenant ON core.table_metadata(tenant_id);
CREATE INDEX idx_table_metadata_project ON core.table_metadata(project_id);
CREATE INDEX idx_table_metadata_physical ON core.table_metadata(physical_table_name);
CREATE INDEX idx_table_metadata_active ON core.table_metadata(project_id) 
  WHERE is_active = TRUE AND is_deleted = FALSE;

-- Triggers
CREATE TRIGGER trg_table_metadata_touch 
  BEFORE UPDATE ON core.table_metadata 
  FOR EACH ROW EXECUTE FUNCTION app.touch_row();

CREATE TRIGGER trg_table_metadata_softdel 
  BEFORE DELETE ON core.table_metadata 
  FOR EACH ROW EXECUTE FUNCTION app.soft_delete();

CREATE TRIGGER trg_table_metadata_audit 
  AFTER INSERT OR UPDATE OR DELETE ON core.table_metadata 
  FOR EACH ROW EXECUTE FUNCTION ops.log_audit();

-- RLS
ALTER TABLE core.table_metadata ENABLE ROW LEVEL SECURITY;

CREATE POLICY rls_table_metadata_tenant ON core.table_metadata
  USING (tenant_id = app.current_tenant())
  WITH CHECK (tenant_id = app.current_tenant());
```

### Fields Schema (JSONB)

```json
[
  {
    "name": "name",
    "type": "string",
    "required": true,
    "maxLength": 200,
    "defaultValue": null
  },
  {
    "name": "price",
    "type": "decimal",
    "required": true,
    "precision": 10,
    "scale": 2,
    "defaultValue": "0.00"
  },
  {
    "name": "stock",
    "type": "integer",
    "required": true,
    "defaultValue": 0
  },
  {
    "name": "is_active",
    "type": "boolean",
    "required": true,
    "defaultValue": true
  },
  {
    "name": "images",
    "type": "array",
    "required": false
  },
  {
    "name": "category_id",
    "type": "reference",
    "required": true,
    "references": "categories"
  }
]
```

### Desteklenen Field Types

| Type | PostgreSQL Type | A√ßƒ±klama |
|------|----------------|----------|
| `string` | `VARCHAR(n)` | Text, max length |
| `text` | `TEXT` | Uzun text |
| `integer` | `INTEGER` | Tam sayƒ± |
| `decimal` | `NUMERIC(p,s)` | Ondalƒ±klƒ± sayƒ± |
| `boolean` | `BOOLEAN` | true/false |
| `date` | `DATE` | Tarih |
| `datetime` | `TIMESTAMPTZ` | Tarih + saat |
| `array` | `JSONB` | Dizi |
| `object` | `JSONB` | Obje |
| `reference` | `INTEGER` | Foreign key |

---

## 5. app.generic_data - Generic Table Pattern ‚≠ê

> **üéØ KRƒ∞Tƒ∞K:** Bu tablo, her kullanƒ±cƒ± tablosu i√ßin fiziksel PostgreSQL tablosu olu≈üturmak yerine, t√ºm user-defined datalarƒ± tek bir tabloda JSONB ile saklamamƒ±zƒ± saƒülar. **Scalability'nin temeli!**

### ‚ö†Ô∏è Neden Generic Pattern?

**ESKI YAPI≈û (‚ùå Sorunlu)**:
```
Tenant 1, Project 1, "customers" tablosu ‚Üí PostgreSQL'de `tenant_1_project_1_customers_123` tablosu
Tenant 1, Project 1, "orders" tablosu    ‚Üí PostgreSQL'de `tenant_1_project_1_orders_456` tablosu
Tenant 2, Project 1, "products" tablosu  ‚Üí PostgreSQL'de `tenant_2_project_1_products_789` tablosu
...
40 tenant √ó 20 proje √ó 50 tablo = 40,000 fiziksel PostgreSQL tablosu! üí• KABUS!
```

**YENƒ∞ YAPI≈û (‚úÖ Doƒüru)**:
```
TE t√ºm user-defined veriler ‚Üí `app.generic_data` tablosunda JSONB ile
Her kayƒ±t: {tenant_id, project_id, table_id, data: {...}}
40 tenant √ó herhangi sayƒ±da proje/tablo ‚Üí Sadece 1 fiziksel tablo! ‚ú®
```

### Tablo Tanƒ±mƒ±

```sql
CREATE TABLE app.generic_data (
  id BIGSERIAL PRIMARY KEY,
  
  -- Multi-tenant izolasyon
  tenant_id INTEGER NOT NULL REFERENCES core.tenants(id) ON DELETE CASCADE,
  project_id INTEGER NOT NULL REFERENCES core.projects(id) ON DELETE CASCADE,
  table_id INTEGER NOT NULL REFERENCES core.table_metadata(id) ON DELETE CASCADE,
  
  -- üéØ T√ºm user verisi burada (JSONB)
  data JSONB NOT NULL DEFAULT '{}'::jsonb,
  
  -- üîç Full-text search i√ßin (pg_trgm)
  search_text TEXT GENERATED ALWAYS AS (
    jsonb_to_text(data)
  ) STORED,
  
  -- Soft delete
  is_deleted BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMPTZ,
  deleted_by INTEGER,
  
  -- Audit
  version INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  created_by INTEGER,
  updated_by INTEGER,
  
  -- ‚ö° Composite unique constraint
  CONSTRAINT unique_generic_data_per_table UNIQUE (tenant_id, project_id, table_id, id)
);

-- üöÄ Critical Indexes
CREATE INDEX idx_generic_data_tenant 
  ON app.generic_data(tenant_id);

CREATE INDEX idx_generic_data_project 
  ON app.generic_data(project_id);

CREATE INDEX idx_generic_data_table 
  ON app.generic_data(table_id);

CREATE INDEX idx_generic_data_composite 
  ON app.generic_data(tenant_id, project_id, table_id) 
  WHERE is_deleted = FALSE;

-- üîç Full-text search index (GiST)
CREATE INDEX idx_generic_data_search 
  ON app.generic_data USING GIN(to_tsvector('english', search_text));

-- üìä JSONB field indexes (√∂rnek: price alanƒ±na index)
-- CREATE INDEX idx_generic_data_price 
--   ON app.generic_data((data->>'price')) 
--   WHERE data->>'price' IS NOT NULL;

-- üéØ GIN index (JSONB i√ßinde arama i√ßin)
CREATE INDEX idx_generic_data_jsonb 
  ON app.generic_data USING GIN(data);

-- Triggers
CREATE TRIGGER trg_generic_data_touch 
  BEFORE UPDATE ON app.generic_data 
  FOR EACH ROW EXECUTE FUNCTION app.touch_row();

CREATE TRIGGER trg_generic_data_softdel 
  BEFORE DELETE ON app.generic_data 
  FOR EACH ROW EXECUTE FUNCTION app.soft_delete();

CREATE TRIGGER trg_generic_data_audit 
  AFTER INSERT OR UPDATE OR DELETE ON app.generic_data 
  FOR EACH ROW EXECUTE FUNCTION ops.log_audit();

-- RLS (Row Level Security)
ALTER TABLE app.generic_data ENABLE ROW LEVEL SECURITY;

CREATE POLICY rls_generic_data_tenant ON app.generic_data
  USING (tenant_id = app.current_tenant())
  WITH CHECK (tenant_id = app.current_tenant());
```

### Data √ñrneƒüi (JSONB)

**√ñrnek 1: E-commerce Product**
```json
{
  "id": 1,
  "tenant_id": 5,
  "project_id": 12,
  "table_id": 34,  // "products" tablosu
  "data": {
    "name": "iPhone 15 Pro",
    "sku": "IPHONE15PRO-256-BLACK",
    "price": 1299.99,
    "currency": "USD",
    "stock": 45,
    "category_id": 7,
    "images": [
      "https://cdn.example.com/iphone15-1.jpg",
      "https://cdn.example.com/iphone15-2.jpg"
    ],
    "specs": {
      "color": "Black Titanium",
      "storage": "256GB",
      "screen": "6.1 inch"
    },
    "is_active": true
  },
  "created_at": "2025-10-21T10:30:00Z"
}
```

**√ñrnek 2: CRM Contact**
```json
{
  "id": 2,
  "tenant_id": 5,
  "project_id": 13,
  "table_id": 56,  // "contacts" tablosu
  "data": {
    "first_name": "John",
    "last_name": "Doe",
    "email": "john.doe@example.com",
    "phone": "+1-555-1234",
    "company": "Acme Corp",
    "position": "CTO",
    "tags": ["VIP", "Enterprise"],
    "custom_fields": {
      "linkedin": "https://linkedin.com/in/johndoe",
      "birthday": "1985-03-15"
    }
  },
  "created_at": "2025-10-20T15:45:00Z"
}
```

### Nasƒ±l Kullanƒ±lƒ±r?

**1. Yeni kayƒ±t ekleme:**
```sql
SELECT app.set_context(5, 42);  -- tenant_id=5, user_id=42

INSERT INTO app.generic_data (tenant_id, project_id, table_id, data, created_by)
VALUES (
  5, 
  12, 
  34, 
  '{
    "name": "MacBook Pro",
    "price": 2499.99,
    "stock": 10
  }'::jsonb,
  42
);
```

**2. Kayƒ±tlarƒ± okuma:**
```sql
SELECT 
  id,
  data->>'name' AS name,
  (data->>'price')::numeric AS price,
  (data->>'stock')::integer AS stock,
  created_at
FROM app.generic_data
WHERE tenant_id = 5
  AND project_id = 12
  AND table_id = 34
  AND is_deleted = FALSE
ORDER BY created_at DESC;
```

**3. JSONB i√ßinde arama:**
```sql
-- Fiyatƒ± $1000'dan fazla olan √ºr√ºnler
SELECT * FROM app.generic_data
WHERE tenant_id = 5
  AND table_id = 34
  AND (data->>'price')::numeric > 1000;

-- ƒ∞sminde "iPhone" ge√ßen √ºr√ºnler
SELECT * FROM app.generic_data
WHERE tenant_id = 5
  AND table_id = 34
  AND data->>'name' ILIKE '%iPhone%';

-- JSON i√ßinde array arama
SELECT * FROM app.generic_data
WHERE tenant_id = 5
  AND table_id = 34
  AND data @> '{"tags": ["VIP"]}';
```

**4. G√ºncelleme:**
```sql
UPDATE app.generic_data
SET 
  data = jsonb_set(data, '{price}', '1399.99'::jsonb),
  updated_by = 42
WHERE tenant_id = 5
  AND id = 123;
```

**5. Soft delete:**
```sql
DELETE FROM app.generic_data
WHERE tenant_id = 5 AND id = 123;
-- Trigger otomatik olarak is_deleted=TRUE yapar
```

### Performance Tips

1. **Specific JSONB indexes** (sƒ±k sorgulanan alanlar i√ßin):
```sql
CREATE INDEX idx_products_price 
  ON app.generic_data((data->>'price')::numeric)
  WHERE table_id = 34 AND (data->>'price') IS NOT NULL;

CREATE INDEX idx_products_category 
  ON app.generic_data((data->>'category_id')::integer)
  WHERE table_id = 34;
```

2. **Partitioning** (√ßok b√ºy√ºk data i√ßin):
```sql
-- Tenant bazƒ±nda partition (opsiyonel, ileri seviye)
CREATE TABLE app.generic_data_tenant_1 
  PARTITION OF app.generic_data
  FOR VALUES FROM (1) TO (2);
```

3. **Materialized Views** (raporlar i√ßin):
```sql
CREATE MATERIALIZED VIEW mv_product_summary AS
SELECT 
  tenant_id,
  project_id,
  COUNT(*) AS total_products,
  SUM((data->>'price')::numeric) AS total_value,
  AVG((data->>'price')::numeric) AS avg_price
FROM app.generic_data
WHERE table_id = 34 AND is_deleted = FALSE
GROUP BY tenant_id, project_id;

-- Index
CREATE UNIQUE INDEX ON mv_product_summary(tenant_id, project_id);

-- Refresh (her gece cron ile)
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_product_summary;
```

### Migration Guide (Eski ‚Üí Yeni)

Detaylƒ± migration rehberi i√ßin bkz: [09-Oneriler/01_GENERIC_TABLE_PATTERN.md](../09-Oneriler/01_GENERIC_TABLE_PATTERN.md)

**√ñzetle:**
1. `app.generic_data` tablosunu olu≈ütur
2. Mevcut fiziksel tablolarƒ± `generic_data`'ya migrate et
3. Backend API'leri JSONB kullanacak ≈üekilde g√ºncelle
4. Frontend'i yeni API'lere uyarla
5. Eski fiziksel tablolarƒ± sil

---

## 6. core.api_keys - API Eri≈üim Kontrol√º

### Tablo Tanƒ±mƒ±

```sql
CREATE TABLE core.api_keys (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INTEGER NOT NULL REFERENCES core.tenants(id) ON DELETE CASCADE,
  project_id INTEGER REFERENCES core.projects(id) ON DELETE CASCADE,
  user_id INTEGER NOT NULL REFERENCES core.users(id) ON DELETE CASCADE,
  
  -- Key Info
  name VARCHAR(100) NOT NULL,  -- "Production API", "Test API"
  key_prefix VARCHAR(20) UNIQUE,  -- "hzm_live_", "hzm_test_"
  key_hash VARCHAR(255) NOT NULL,  -- Hash of full key
  key_encrypted TEXT NOT NULL,  -- Encrypted full key
  
  -- Permissions
  permissions JSONB DEFAULT '{}'::jsonb,
  scopes TEXT[] DEFAULT '{}',  -- ['read:products', 'write:orders']
  
  -- Rate Limiting
  rate_limit_per_minute INTEGER DEFAULT 60,
  rate_limit_per_day INTEGER DEFAULT 10000,
  
  -- IP Restrictions
  allowed_ips TEXT[] DEFAULT '{}',
  allowed_domains TEXT[] DEFAULT '{}',
  
  -- Usage Tracking
  last_used_at TIMESTAMPTZ,
  total_requests BIGINT DEFAULT 0,
  total_errors INTEGER DEFAULT 0,
  
  -- Lifecycle
  expires_at TIMESTAMPTZ,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  revoked_at TIMESTAMPTZ,
  revoked_by INTEGER,
  revoke_reason TEXT,
  version INTEGER DEFAULT 1
);

-- Indexes
CREATE INDEX idx_api_keys_tenant ON core.api_keys(tenant_id);
CREATE INDEX idx_api_keys_project ON core.api_keys(project_id);
CREATE INDEX idx_api_keys_prefix ON core.api_keys(key_prefix);
CREATE INDEX idx_api_keys_active ON core.api_keys(tenant_id) 
  WHERE is_active = TRUE;

-- Triggers
CREATE TRIGGER trg_api_keys_touch 
  BEFORE UPDATE ON core.api_keys 
  FOR EACH ROW EXECUTE FUNCTION app.touch_row();

CREATE TRIGGER trg_api_keys_audit 
  AFTER INSERT OR UPDATE OR DELETE ON core.api_keys 
  FOR EACH ROW EXECUTE FUNCTION ops.log_audit();

-- RLS
ALTER TABLE core.api_keys ENABLE ROW LEVEL SECURITY;

CREATE POLICY rls_api_keys_tenant ON core.api_keys
  USING (tenant_id = app.current_tenant())
  WITH CHECK (tenant_id = app.current_tenant());
```

### Permissions (JSONB)

```json
{
  "read": true,
  "write": true,
  "delete": false,
  "admin": false
}
```

### Scopes (Array)

```javascript
[
  'read:products',      // √úr√ºnleri okuyabilir
  'write:products',     // √úr√ºn olu≈üturabilir/g√ºncelleyebilir
  'delete:products',    // √úr√ºn silebilir
  'read:orders',        // Sipari≈üleri okuyabilir
  'write:orders',       // Sipari≈ü olu≈üturabilir
  'admin:all'           // T√ºm yetkilere sahip
]
```

### API Key Format

```
hzm_live_AbCdEfGh123456789...     // Production
hzm_test_XyZ987654321...          // Test
```

---

## üîó ƒ∞lgili D√∂k√ºmanlar

- [01_PostgreSQL_Setup.md](01_PostgreSQL_Setup.md) - Trigger functions
- [03_i18n_Tables.md](03_i18n_Tables.md) - cfg.languages, cfg.currencies
- [04_RLS_Multi_Tenant_Strategy.md](04_RLS_Multi_Tenant_Strategy.md) - RLS policies
- [12_Table_Template.md](12_Table_Template.md) - Standard table template

---

**[‚óÄÔ∏è Geri: PostgreSQL Setup](01_PostgreSQL_Setup.md) | [Ana Sayfa](README.md) | [ƒ∞leri: i18n Tables ‚ñ∂Ô∏è](03_i18n_Tables.md)**


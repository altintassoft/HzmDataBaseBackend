# üéØ DATABASE MIGRATION ORDER (Zorunlu Sƒ±ralama)

> **‚ö†Ô∏è UYARI: Bu sƒ±ralama deƒüi≈ütirilirse foreign key hatalarƒ± alƒ±rsƒ±nƒ±z!**

[Ana Sayfa](../README.md) | [Migration Guide](README.md)

---

## üìã Dependency Chain (Baƒüƒ±mlƒ±lƒ±k Zinciri)

### üîë Temel Kural:
**Referans edilen tablo (foreign key target) √ñNCE olu≈üturulmalƒ±!**

```
A ‚Üí B  (B tablosu A'ya foreign key atƒ±yorsa, A √∂nce olu≈üturulmalƒ±)
```

---

## ‚úÖ Doƒüru Sƒ±ralama (Deƒüi≈ütirmeyin!)

### **Phase 1: Extensions & Schemas & Functions (001_initial_schema.sql)**
```sql
-- 1.1 Extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS citext;
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- 1.2 Schemas
CREATE SCHEMA IF NOT EXISTS app;
CREATE SCHEMA IF NOT EXISTS core;
CREATE SCHEMA IF NOT EXISTS cfg;
CREATE SCHEMA IF NOT EXISTS ops;
CREATE SCHEMA IF NOT EXISTS comms;
CREATE SCHEMA IF NOT EXISTS billing;

-- 1.3 Helper Functions (no dependencies)
CREATE FUNCTION app.set_context(...);
CREATE FUNCTION app.current_tenant();
CREATE FUNCTION app.current_user_id();
CREATE FUNCTION app.touch_row();
CREATE FUNCTION app.soft_delete();
CREATE FUNCTION ops.log_audit();
```

**Neden bu sƒ±ra?**
- Extensions √∂nce (√ß√ºnk√º fonksiyonlar kullanabilir)
- Schemas sonra (√ß√ºnk√º tablolar schemas i√ßinde)
- Functions en son (√ß√ºnk√º tablolar kullanacak)

---

### **Phase 2: Config Tables - Foreign Key YOK (001_initial_schema.sql)**
```sql
-- 2.1 Languages (no dependencies)
CREATE TABLE cfg.languages (
  code VARCHAR(10) PRIMARY KEY,
  name VARCHAR(100),
  ...
);

-- 2.2 Currencies (no dependencies)
CREATE TABLE cfg.currencies (
  code VARCHAR(3) PRIMARY KEY,
  name VARCHAR(100),
  ...
);

-- 2.3 Exchange Rates (languages ve currencies'e baƒülƒ±)
CREATE TABLE cfg.exchange_rates (
  from_currency VARCHAR(3) REFERENCES cfg.currencies(code),  -- ‚úÖ currencies zaten var
  to_currency VARCHAR(3) REFERENCES cfg.currencies(code),
  ...
);

-- 2.4 Translations (languages'e baƒülƒ±)
CREATE TABLE cfg.translations (
  language_code VARCHAR(10) REFERENCES cfg.languages(code),  -- ‚úÖ languages zaten var
  ...
);
```

**Neden bu sƒ±ra?**
- `languages` ve `currencies` √∂nce (foreign key YOK)
- `exchange_rates` sonra (currencies'e referans veriyor)
- `translations` sonra (languages'e referans veriyor)

---

### **Phase 3: Ops Tables - Foreign Key YOK (001_initial_schema.sql)**
```sql
-- 3.1 Audit Logs (no foreign keys to core tables yet)
CREATE TABLE ops.audit_logs (
  id BIGSERIAL PRIMARY KEY,
  tenant_id INT,  -- ‚ö†Ô∏è Foreign key YOK (hen√ºz tenants tablosu yok)
  user_id INT,    -- ‚ö†Ô∏è Foreign key YOK (hen√ºz users tablosu yok)
  action VARCHAR(50),
  ...
);

-- 3.2 System Logs (no dependencies)
CREATE TABLE ops.system_logs (
  id BIGSERIAL PRIMARY KEY,
  level VARCHAR(20),
  message TEXT,
  ...
);

-- 3.3 User Activities (no foreign keys yet)
CREATE TABLE ops.user_activities (
  id BIGSERIAL PRIMARY KEY,
  tenant_id INT,
  user_id INT,
  ...
);
```

**Neden foreign key yok?**
- Circular dependency: `core.users` ‚Üí `ops.audit_logs` ve `ops.audit_logs` ‚Üí `core.users`
- √á√∂z√ºm: ƒ∞lk √∂nce foreign key OLMADAN olu≈ütur, sonra ALTER TABLE ile ekle (opsiyonel)

---

### **Phase 4: Core Tables - SIRALAMA KRƒ∞Tƒ∞K! (001_initial_schema.sql)**

#### 4.1 core.tenants (ƒ∞LK √ñNCE!)
```sql
CREATE TABLE core.tenants (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  default_language VARCHAR(10) REFERENCES cfg.languages(code),  -- ‚úÖ languages zaten var
  default_currency VARCHAR(3) REFERENCES cfg.currencies(code),  -- ‚úÖ currencies zaten var
  ...
);
```
**Neden √∂nce?** √á√ºnk√º `core.users`, `core.projects`, `core.api_keys` hepsi `tenant_id` ile baƒülƒ±!

---

#### 4.2 core.users (tenants'tan SONRA!)
```sql
CREATE TABLE core.users (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- ‚úÖ tenants zaten var
  email citext UNIQUE NOT NULL,
  ...
);

-- RLS (Row Level Security)
ALTER TABLE core.users ENABLE ROW LEVEL SECURITY;
CREATE POLICY rls_users_tenant ON core.users
  USING (tenant_id = app.current_tenant());
```
**Neden sonra?** √á√ºnk√º `tenant_id REFERENCES core.tenants(id)`

---

#### 4.3 core.user_sessions (users'tan SONRA!)
```sql
CREATE TABLE core.user_sessions (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- ‚úÖ tenants zaten var
  user_id INT NOT NULL REFERENCES core.users(id),      -- ‚úÖ users zaten var
  token VARCHAR(500) UNIQUE NOT NULL,
  ...
);

ALTER TABLE core.user_sessions ENABLE ROW LEVEL SECURITY;
CREATE POLICY rls_sessions_tenant ON core.user_sessions
  USING (tenant_id = app.current_tenant());
```

---

#### 4.4 core.user_2fa (users'tan SONRA!)
```sql
CREATE TABLE core.user_2fa (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),
  user_id INT UNIQUE REFERENCES core.users(id),  -- ‚úÖ users zaten var
  method VARCHAR(20) NOT NULL,
  ...
);

ALTER TABLE core.user_2fa ENABLE ROW LEVEL SECURITY;
```

---

#### 4.5 core.projects (users'tan SONRA!)
```sql
CREATE TABLE core.projects (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- ‚úÖ tenants zaten var
  user_id INT NOT NULL REFERENCES core.users(id),      -- ‚úÖ users zaten var
  name VARCHAR(200) NOT NULL,
  ...
);

ALTER TABLE core.projects ENABLE ROW LEVEL SECURITY;
CREATE POLICY rls_projects_tenant ON core.projects
  USING (tenant_id = app.current_tenant());
```

---

#### 4.6 core.table_metadata (projects'ten SONRA!)
```sql
CREATE TABLE core.table_metadata (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),    -- ‚úÖ tenants zaten var
  project_id INT NOT NULL REFERENCES core.projects(id),  -- ‚úÖ projects zaten var
  table_name VARCHAR(100) NOT NULL,
  ...
);

ALTER TABLE core.table_metadata ENABLE ROW LEVEL SECURITY;
```

---

#### 4.7 app.generic_data (table_metadata'dan SONRA!)
```sql
CREATE TABLE app.generic_data (
  id BIGSERIAL PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),         -- ‚úÖ tenants zaten var
  project_id INT NOT NULL REFERENCES core.projects(id),       -- ‚úÖ projects zaten var
  table_id INT NOT NULL REFERENCES core.table_metadata(id),   -- ‚úÖ table_metadata zaten var
  data JSONB NOT NULL DEFAULT '{}'::jsonb,
  ...
);

ALTER TABLE app.generic_data ENABLE ROW LEVEL SECURITY;
CREATE POLICY rls_generic_data_tenant ON app.generic_data
  USING (tenant_id = app.current_tenant());
```

---

#### 4.8 core.api_keys (users'tan SONRA!)
```sql
CREATE TABLE core.api_keys (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- ‚úÖ tenants zaten var
  user_id INT NOT NULL REFERENCES core.users(id),      -- ‚úÖ users zaten var
  name VARCHAR(100) NOT NULL,
  key_hash VARCHAR(255) NOT NULL,
  ...
);

ALTER TABLE core.api_keys ENABLE ROW LEVEL SECURITY;
```

---

### **Phase 5: Files & Media (users'tan SONRA!) (006_add_file_storage.sql)**
```sql
-- 5.1 core.files
CREATE TABLE core.files (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- ‚úÖ tenants zaten var
  uploaded_by INT REFERENCES core.users(id),           -- ‚úÖ users zaten var
  original_filename VARCHAR(500),
  ...
);

-- 5.2 core.image_variants
CREATE TABLE core.image_variants (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  file_id UUID REFERENCES core.files(id),  -- ‚úÖ files zaten var
  variant_name VARCHAR(50),
  ...
);
```

---

### **Phase 6: Communications (tenants ve users'tan SONRA!) (007_add_notifications.sql)**
```sql
-- 6.1 comms.notifications
CREATE TABLE comms.notifications (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- ‚úÖ
  user_id INT REFERENCES core.users(id),               -- ‚úÖ
  ...
);

-- 6.2 comms.email_queue
CREATE TABLE comms.email_queue (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- ‚úÖ
  to_email citext,
  ...
);
```

---

### **Phase 7: Webhooks (tenants'tan SONRA!) (008_add_webhooks.sql)**
```sql
-- 7.1 comms.webhooks
CREATE TABLE comms.webhooks (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- ‚úÖ
  url VARCHAR(500) NOT NULL,
  ...
);

-- 7.2 comms.webhook_deliveries
CREATE TABLE comms.webhook_deliveries (
  id BIGSERIAL PRIMARY KEY,
  webhook_id INT REFERENCES comms.webhooks(id),  -- ‚úÖ webhooks zaten var
  event_type VARCHAR(100),
  ...
);
```

---

### **Phase 8: Billing (tenants'tan SONRA!) (009_add_billing.sql)**
```sql
-- 8.1 billing.subscriptions
CREATE TABLE billing.subscriptions (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT UNIQUE REFERENCES core.tenants(id),  -- ‚úÖ
  plan_id INT,
  ...
);

-- 8.2 billing.usage_records
CREATE TABLE billing.usage_records (
  id BIGSERIAL PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- ‚úÖ
  resource_type VARCHAR(50),
  ...
);
```

---

### **Phase 9: Organizations (users'tan SONRA!) (002_add_organizations.sql)**
```sql
CREATE TABLE core.organizations (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- ‚úÖ
  owner_id INT NOT NULL REFERENCES core.users(id),     -- ‚úÖ
  name VARCHAR(200) NOT NULL,
  ...
);
```

---

### **Phase 10: RBAC (users ve organizations'tan SONRA!) (003_add_rbac.sql)**
```sql
-- 10.1 core.roles
CREATE TABLE core.roles (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),
  name VARCHAR(100) NOT NULL,
  ...
);

-- 10.2 core.permissions
CREATE TABLE core.permissions (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  resource VARCHAR(100) NOT NULL,
  action VARCHAR(50) NOT NULL,
  ...
);

-- 10.3 core.role_permissions
CREATE TABLE core.role_permissions (
  role_id INT REFERENCES core.roles(id),         -- ‚úÖ roles zaten var
  permission_id INT REFERENCES core.permissions(id),  -- ‚úÖ permissions zaten var
  PRIMARY KEY (role_id, permission_id)
);

-- 10.4 core.user_roles
CREATE TABLE core.user_roles (
  user_id INT REFERENCES core.users(id),  -- ‚úÖ users zaten var
  role_id INT REFERENCES core.roles(id),  -- ‚úÖ roles zaten var
  PRIMARY KEY (user_id, role_id)
);
```

---

## üìä Visual Dependency Graph

```
cfg.languages ‚îÄ‚îê
cfg.currencies ‚îº‚îÄ‚îÄ> core.tenants ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ> core.users ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ> core.user_sessions
               ‚îÇ                    ‚îÇ                 ‚îú‚îÄ‚îÄ> core.user_2fa
               ‚îÇ                    ‚îÇ                 ‚îú‚îÄ‚îÄ> core.api_keys
               ‚îÇ                    ‚îÇ                 ‚îú‚îÄ‚îÄ> core.files
               ‚îÇ                    ‚îÇ                 ‚îú‚îÄ‚îÄ> core.organizations
               ‚îÇ                    ‚îÇ                 ‚îî‚îÄ‚îÄ> comms.notifications
               ‚îÇ                    ‚îÇ
               ‚îÇ                    ‚îú‚îÄ‚îÄ> core.projects ‚îÄ‚îÄ> core.table_metadata ‚îÄ‚îÄ> app.generic_data
               ‚îÇ                    ‚îÇ
               ‚îÇ                    ‚îú‚îÄ‚îÄ> comms.email_queue
               ‚îÇ                    ‚îú‚îÄ‚îÄ> comms.webhooks ‚îÄ‚îÄ> comms.webhook_deliveries
               ‚îÇ                    ‚îî‚îÄ‚îÄ> billing.subscriptions
                                    ‚îî‚îÄ‚îÄ> billing.usage_records

ops.audit_logs ‚îÄ‚îÄ‚îÄ‚îÄ> (no foreign keys initially)
ops.system_logs ‚îÄ‚îÄ‚îÄ> (no foreign keys)
```

---

## ‚ùå Yaygƒ±n Hatalar

### ‚ùå Hata 1: Users'ƒ± Tenants'tan √∂nce olu≈üturmak
```sql
-- YANLI≈û! ‚ùå
CREATE TABLE core.users (
  tenant_id INT REFERENCES core.tenants(id)  -- ‚ùå tenants hen√ºz yok!
);
CREATE TABLE core.tenants (...);
```

**Hata Mesajƒ±:**
```
ERROR: relation "core.tenants" does not exist
```

**√á√∂z√ºm:** `core.tenants` √∂nce olu≈üturulmalƒ±!

---

### ‚ùå Hata 2: Generic Data'yƒ± Table Metadata'dan √∂nce olu≈üturmak
```sql
-- YANLI≈û! ‚ùå
CREATE TABLE app.generic_data (
  table_id INT REFERENCES core.table_metadata(id)  -- ‚ùå table_metadata hen√ºz yok!
);
CREATE TABLE core.table_metadata (...);
```

**√á√∂z√ºm:** `core.table_metadata` √∂nce olu≈üturulmalƒ±!

---

### ‚ùå Hata 3: Webhook Deliveries'i Webhooks'tan √∂nce olu≈üturmak
```sql
-- YANLI≈û! ‚ùå
CREATE TABLE comms.webhook_deliveries (
  webhook_id INT REFERENCES comms.webhooks(id)  -- ‚ùå webhooks hen√ºz yok!
);
CREATE TABLE comms.webhooks (...);
```

**√á√∂z√ºm:** `comms.webhooks` √∂nce olu≈üturulmalƒ±!

---

## ‚úÖ Doƒürulama Scripti

Migration'lardan sonra dependency chain'i doƒürulamak i√ßin:

```sql
-- Foreign key'leri kontrol et
SELECT
  tc.table_schema,
  tc.table_name,
  kcu.column_name,
  ccu.table_schema AS foreign_table_schema,
  ccu.table_name AS foreign_table_name,
  ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
  AND tc.table_schema IN ('core', 'cfg', 'ops', 'comms', 'billing', 'app')
ORDER BY tc.table_schema, tc.table_name;
```

**Beklenen sonu√ß:**
- Her foreign key'in target tablosu mevcut olmalƒ±
- Hi√ßbir tablo kendisinden √∂nce olu≈üturulmamƒ±≈ü bir tabloya referans vermemeli

---

## üöÄ Quick Start (Doƒüru Sƒ±ralama)

```bash
# 1. Extensions, Schemas, Functions
psql $DATABASE_URL -f migrations/001_initial_schema.sql

# 2. Organizations
psql $DATABASE_URL -f migrations/002_add_organizations.sql

# 3. RBAC
psql $DATABASE_URL -f migrations/003_add_rbac.sql

# 4. Generic Data
psql $DATABASE_URL -f migrations/004_add_generic_data.sql

# 5. Microservices
psql $DATABASE_URL -f migrations/005_add_microservices.sql

# 6. File Storage
psql $DATABASE_URL -f migrations/006_add_file_storage.sql

# 7. Notifications
psql $DATABASE_URL -f migrations/007_add_notifications.sql

# 8. Webhooks
psql $DATABASE_URL -f migrations/008_add_webhooks.sql

# 9. Billing
psql $DATABASE_URL -f migrations/009_add_billing.sql

# 10. Monitoring
psql $DATABASE_URL -f migrations/010_add_monitoring.sql

# 11. Feature Flags
psql $DATABASE_URL -f migrations/011_add_feature_flags.sql

# 12. Seeds (optional)
psql $DATABASE_URL -f migrations/seeds/001_default_languages.sql
psql $DATABASE_URL -f migrations/seeds/002_default_currencies.sql
psql $DATABASE_URL -f migrations/seeds/003_platform_admin.sql
```

---

## üéØ √ñzet

| Sƒ±ra | Tablo/Schema | Neden Bu Sƒ±rada? |
|------|--------------|------------------|
| 1 | Extensions | Fonksiyonlar kullanabilir (uuid-ossp, citext) |
| 2 | Schemas | Tablolar schemas i√ßinde |
| 3 | Functions | Trigger'lar kullanacak |
| 4 | `cfg.languages` | Foreign key YOK |
| 5 | `cfg.currencies` | Foreign key YOK |
| 6 | `cfg.exchange_rates` | currencies'e baƒülƒ± |
| 7 | `ops.audit_logs` | Foreign key YOK (hen√ºz) |
| 8 | `core.tenants` | languages/currencies'e baƒülƒ± |
| 9 | `core.users` | tenants'a baƒülƒ± |
| 10 | `core.user_sessions` | users'a baƒülƒ± |
| 11 | `core.user_2fa` | users'a baƒülƒ± |
| 12 | `core.projects` | tenants/users'a baƒülƒ± |
| 13 | `core.table_metadata` | projects'e baƒülƒ± |
| 14 | `app.generic_data` | table_metadata'ya baƒülƒ± |
| 15 | `core.api_keys` | users'a baƒülƒ± |
| 16 | `core.files` | users'a baƒülƒ± |
| 17 | `core.image_variants` | files'a baƒülƒ± |
| 18 | `comms.notifications` | users'a baƒülƒ± |
| 19 | `comms.webhooks` | tenants'a baƒülƒ± |
| 20 | `comms.webhook_deliveries` | webhooks'a baƒülƒ± |
| 21 | `billing.subscriptions` | tenants'a baƒülƒ± |

---

**‚ö†Ô∏è BU SIRAYI DEƒûƒ∞≈ûTƒ∞RMEYƒ∞N!** Foreign key hatalarƒ± alƒ±rsƒ±nƒ±z. üî•

[‚óÄÔ∏è Migration Guide](README.md) | [Ana Sayfa](../README.md)


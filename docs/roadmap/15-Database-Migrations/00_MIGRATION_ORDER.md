# ğŸ¯ DATABASE MIGRATION ORDER (Zorunlu SÄ±ralama)

> **âš ï¸ UYARI: Bu sÄ±ralama deÄŸiÅŸtirilirse foreign key hatalarÄ± alÄ±rsÄ±nÄ±z!**

[Ana Sayfa](../README.md) | [Migration Guide](README.md)

---

## ğŸ“‹ Dependency Chain (BaÄŸÄ±mlÄ±lÄ±k Zinciri)

### ğŸ”‘ Temel Kural:
**Referans edilen tablo (foreign key target) Ã–NCE oluÅŸturulmalÄ±!**

```
A â†’ B  (B tablosu A'ya foreign key atÄ±yorsa, A Ã¶nce oluÅŸturulmalÄ±)
```

---

## âœ… DoÄŸru SÄ±ralama (DeÄŸiÅŸtirmeyin!)

### **Phase 1: Extensions & Schemas & Functions (001_initial_schema.sql)**
```sql
-- 1.1 Extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS citext;
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- 1.2 Schemas
CREATE SCHEMA IF NOT EXISTS app;
CREATE SCHEMA IF NOT EXISTS core;
CREATE SCHEMA IF NOT EXISTS cfg;
CREATE SCHEMA IF NOT EXISTS ops;
CREATE SCHEMA IF NOT EXISTS comms;
CREATE SCHEMA IF NOT EXISTS billing;

-- 1.3 Helper Functions (no dependencies)
CREATE FUNCTION app.set_context(...);
CREATE FUNCTION app.current_tenant();
CREATE FUNCTION app.current_user_id();
CREATE FUNCTION app.touch_row();
CREATE FUNCTION app.soft_delete();
CREATE FUNCTION ops.log_audit();
```

**Neden bu sÄ±ra?**
- Extensions Ã¶nce (Ã§Ã¼nkÃ¼ fonksiyonlar kullanabilir)
- Schemas sonra (Ã§Ã¼nkÃ¼ tablolar schemas iÃ§inde)
- Functions en son (Ã§Ã¼nkÃ¼ tablolar kullanacak)

---

### **Phase 2: Config Tables - Foreign Key YOK (001_initial_schema.sql)**
```sql
-- 2.1 Languages (no dependencies)
CREATE TABLE cfg.languages (
  code VARCHAR(10) PRIMARY KEY,
  name VARCHAR(100),
  ...
);

-- 2.2 Currencies (no dependencies)
CREATE TABLE cfg.currencies (
  code VARCHAR(3) PRIMARY KEY,
  name VARCHAR(100),
  ...
);

-- 2.3 Exchange Rates (languages ve currencies'e baÄŸlÄ±)
CREATE TABLE cfg.exchange_rates (
  from_currency VARCHAR(3) REFERENCES cfg.currencies(code),  -- âœ… currencies zaten var
  to_currency VARCHAR(3) REFERENCES cfg.currencies(code),
  ...
);

-- 2.4 Translations (languages'e baÄŸlÄ±)
CREATE TABLE cfg.translations (
  language_code VARCHAR(10) REFERENCES cfg.languages(code),  -- âœ… languages zaten var
  ...
);
```

**Neden bu sÄ±ra?**
- `languages` ve `currencies` Ã¶nce (foreign key YOK)
- `exchange_rates` sonra (currencies'e referans veriyor)
- `translations` sonra (languages'e referans veriyor)

---

### **Phase 3: Ops Tables - Foreign Key YOK (001_initial_schema.sql)**
```sql
-- 3.1 Audit Logs (no foreign keys to core tables yet)
CREATE TABLE ops.audit_logs (
  id BIGSERIAL PRIMARY KEY,
  tenant_id INT,  -- âš ï¸ Foreign key YOK (henÃ¼z tenants tablosu yok)
  user_id INT,    -- âš ï¸ Foreign key YOK (henÃ¼z users tablosu yok)
  action VARCHAR(50),
  ...
);

-- 3.2 System Logs (no dependencies)
CREATE TABLE ops.system_logs (
  id BIGSERIAL PRIMARY KEY,
  level VARCHAR(20),
  message TEXT,
  ...
);

-- 3.3 User Activities (no foreign keys yet)
CREATE TABLE ops.user_activities (
  id BIGSERIAL PRIMARY KEY,
  tenant_id INT,
  user_id INT,
  ...
);
```

**Neden foreign key yok?**
- Circular dependency: `core.users` â†’ `ops.audit_logs` ve `ops.audit_logs` â†’ `core.users`
- Ã‡Ã¶zÃ¼m: Ä°lk Ã¶nce foreign key OLMADAN oluÅŸtur, sonra ALTER TABLE ile ekle (opsiyonel)

---

### **Phase 4: Core Tables - SIRALAMA KRÄ°TÄ°K! (001_initial_schema.sql)**

#### 4.1 core.tenants (Ä°LK Ã–NCE!)
```sql
CREATE TABLE core.tenants (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(200) NOT NULL,
  default_language VARCHAR(10) REFERENCES cfg.languages(code),  -- âœ… languages zaten var
  default_currency VARCHAR(3) REFERENCES cfg.currencies(code),  -- âœ… currencies zaten var
  ...
);
```
**Neden Ã¶nce?** Ã‡Ã¼nkÃ¼ `core.users`, `core.projects`, `core.api_keys` hepsi `tenant_id` ile baÄŸlÄ±!

---

#### 4.2 core.users (tenants'tan SONRA!)
```sql
CREATE TABLE core.users (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- âœ… tenants zaten var
  email citext UNIQUE NOT NULL,
  ...
);

-- RLS (Row Level Security)
ALTER TABLE core.users ENABLE ROW LEVEL SECURITY;
CREATE POLICY rls_users_tenant ON core.users
  USING (tenant_id = app.current_tenant());
```
**Neden sonra?** Ã‡Ã¼nkÃ¼ `tenant_id REFERENCES core.tenants(id)`

---

#### 4.3 core.user_sessions (users'tan SONRA!)
```sql
CREATE TABLE core.user_sessions (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- âœ… tenants zaten var
  user_id INT NOT NULL REFERENCES core.users(id),      -- âœ… users zaten var
  token VARCHAR(500) UNIQUE NOT NULL,
  ...
);

ALTER TABLE core.user_sessions ENABLE ROW LEVEL SECURITY;
CREATE POLICY rls_sessions_tenant ON core.user_sessions
  USING (tenant_id = app.current_tenant());
```

---

#### 4.4 core.user_2fa (users'tan SONRA!)
```sql
CREATE TABLE core.user_2fa (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),
  user_id INT UNIQUE REFERENCES core.users(id),  -- âœ… users zaten var
  method VARCHAR(20) NOT NULL,
  ...
);

ALTER TABLE core.user_2fa ENABLE ROW LEVEL SECURITY;
```

---

#### 4.5 core.projects (users'tan SONRA!)
```sql
CREATE TABLE core.projects (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- âœ… tenants zaten var
  user_id INT NOT NULL REFERENCES core.users(id),      -- âœ… users zaten var
  name VARCHAR(200) NOT NULL,
  ...
);

ALTER TABLE core.projects ENABLE ROW LEVEL SECURITY;
CREATE POLICY rls_projects_tenant ON core.projects
  USING (tenant_id = app.current_tenant());
```

---

#### 4.6 core.table_metadata (projects'ten SONRA!)
```sql
CREATE TABLE core.table_metadata (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),    -- âœ… tenants zaten var
  project_id INT NOT NULL REFERENCES core.projects(id),  -- âœ… projects zaten var
  table_name VARCHAR(100) NOT NULL,
  ...
);

ALTER TABLE core.table_metadata ENABLE ROW LEVEL SECURITY;
```

---

#### 4.7 app.generic_data (table_metadata'dan SONRA!)
```sql
CREATE TABLE app.generic_data (
  id BIGSERIAL PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),         -- âœ… tenants zaten var
  project_id INT NOT NULL REFERENCES core.projects(id),       -- âœ… projects zaten var
  table_id INT NOT NULL REFERENCES core.table_metadata(id),   -- âœ… table_metadata zaten var
  data JSONB NOT NULL DEFAULT '{}'::jsonb,
  ...
);

ALTER TABLE app.generic_data ENABLE ROW LEVEL SECURITY;
CREATE POLICY rls_generic_data_tenant ON app.generic_data
  USING (tenant_id = app.current_tenant());
```

---

#### 4.8 core.api_keys (users'tan SONRA!)
```sql
CREATE TABLE core.api_keys (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- âœ… tenants zaten var
  user_id INT NOT NULL REFERENCES core.users(id),      -- âœ… users zaten var
  name VARCHAR(100) NOT NULL,
  key_hash VARCHAR(255) NOT NULL,
  ...
);

ALTER TABLE core.api_keys ENABLE ROW LEVEL SECURITY;
```

---

### **Phase 5: Files & Media (users'tan SONRA!) (006_add_file_storage.sql)**
```sql
-- 5.1 core.files
CREATE TABLE core.files (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- âœ… tenants zaten var
  uploaded_by INT REFERENCES core.users(id),           -- âœ… users zaten var
  original_filename VARCHAR(500),
  ...
);

-- 5.2 core.image_variants
CREATE TABLE core.image_variants (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  file_id UUID REFERENCES core.files(id),  -- âœ… files zaten var
  variant_name VARCHAR(50),
  ...
);
```

---

### **Phase 6: Communications (tenants ve users'tan SONRA!) (007_add_notifications.sql)**
```sql
-- 6.1 comms.notifications
CREATE TABLE comms.notifications (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- âœ…
  user_id INT REFERENCES core.users(id),               -- âœ…
  ...
);

-- 6.2 comms.email_queue
CREATE TABLE comms.email_queue (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- âœ…
  to_email citext,
  ...
);
```

---

### **Phase 7: Webhooks (tenants'tan SONRA!) (008_add_webhooks.sql)**
```sql
-- 7.1 comms.webhooks
CREATE TABLE comms.webhooks (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- âœ…
  url VARCHAR(500) NOT NULL,
  ...
);

-- 7.2 comms.webhook_deliveries
CREATE TABLE comms.webhook_deliveries (
  id BIGSERIAL PRIMARY KEY,
  webhook_id INT REFERENCES comms.webhooks(id),  -- âœ… webhooks zaten var
  event_type VARCHAR(100),
  ...
);
```

---

### **Phase 8: Billing (tenants'tan SONRA!) (009_add_billing.sql)**
```sql
-- 8.1 billing.subscriptions
CREATE TABLE billing.subscriptions (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT UNIQUE REFERENCES core.tenants(id),  -- âœ…
  plan_id INT,
  ...
);

-- 8.2 billing.usage_records
CREATE TABLE billing.usage_records (
  id BIGSERIAL PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- âœ…
  resource_type VARCHAR(50),
  ...
);
```

---

### **Phase 9: Organizations (users'tan SONRA!) (002_add_organizations.sql)**
```sql
CREATE TABLE core.organizations (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),  -- âœ…
  owner_id INT NOT NULL REFERENCES core.users(id),     -- âœ…
  name VARCHAR(200) NOT NULL,
  ...
);
```

---

### **Phase 10: RBAC (users ve organizations'tan SONRA!) (003_add_rbac.sql)**
```sql
-- 10.1 core.roles
CREATE TABLE core.roles (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INT NOT NULL REFERENCES core.tenants(id),
  name VARCHAR(100) NOT NULL,
  ...
);

-- 10.2 core.permissions
CREATE TABLE core.permissions (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  resource VARCHAR(100) NOT NULL,
  action VARCHAR(50) NOT NULL,
  ...
);

-- 10.3 core.role_permissions
CREATE TABLE core.role_permissions (
  role_id INT REFERENCES core.roles(id),         -- âœ… roles zaten var
  permission_id INT REFERENCES core.permissions(id),  -- âœ… permissions zaten var
  PRIMARY KEY (role_id, permission_id)
);

-- 10.4 core.user_roles
CREATE TABLE core.user_roles (
  user_id INT REFERENCES core.users(id),  -- âœ… users zaten var
  role_id INT REFERENCES core.roles(id),  -- âœ… roles zaten var
  PRIMARY KEY (user_id, role_id)
);
```

---

## ğŸ“Š Visual Dependency Graph

```
cfg.languages â”€â”
cfg.currencies â”¼â”€â”€> core.tenants â”€â”€â”¬â”€â”€> core.users â”€â”€â”¬â”€â”€> core.user_sessions
               â”‚                    â”‚                 â”œâ”€â”€> core.user_2fa
               â”‚                    â”‚                 â”œâ”€â”€> core.api_keys
               â”‚                    â”‚                 â”œâ”€â”€> core.files
               â”‚                    â”‚                 â”œâ”€â”€> core.organizations
               â”‚                    â”‚                 â””â”€â”€> comms.notifications
               â”‚                    â”‚
               â”‚                    â”œâ”€â”€> core.projects â”€â”€> core.table_metadata â”€â”€> app.generic_data
               â”‚                    â”‚
               â”‚                    â”œâ”€â”€> comms.email_queue
               â”‚                    â”œâ”€â”€> comms.webhooks â”€â”€> comms.webhook_deliveries
               â”‚                    â””â”€â”€> billing.subscriptions
                                    â””â”€â”€> billing.usage_records

ops.audit_logs â”€â”€â”€â”€> (no foreign keys initially)
ops.system_logs â”€â”€â”€> (no foreign keys)
```

---

## âŒ YaygÄ±n Hatalar

### âŒ Hata 1: Users'Ä± Tenants'tan Ã¶nce oluÅŸturmak
```sql
-- YANLIÅ! âŒ
CREATE TABLE core.users (
  tenant_id INT REFERENCES core.tenants(id)  -- âŒ tenants henÃ¼z yok!
);
CREATE TABLE core.tenants (...);
```

**Hata MesajÄ±:**
```
ERROR: relation "core.tenants" does not exist
```

**Ã‡Ã¶zÃ¼m:** `core.tenants` Ã¶nce oluÅŸturulmalÄ±!

---

### âŒ Hata 2: Generic Data'yÄ± Table Metadata'dan Ã¶nce oluÅŸturmak
```sql
-- YANLIÅ! âŒ
CREATE TABLE app.generic_data (
  table_id INT REFERENCES core.table_metadata(id)  -- âŒ table_metadata henÃ¼z yok!
);
CREATE TABLE core.table_metadata (...);
```

**Ã‡Ã¶zÃ¼m:** `core.table_metadata` Ã¶nce oluÅŸturulmalÄ±!

---

### âŒ Hata 3: Webhook Deliveries'i Webhooks'tan Ã¶nce oluÅŸturmak
```sql
-- YANLIÅ! âŒ
CREATE TABLE comms.webhook_deliveries (
  webhook_id INT REFERENCES comms.webhooks(id)  -- âŒ webhooks henÃ¼z yok!
);
CREATE TABLE comms.webhooks (...);
```

**Ã‡Ã¶zÃ¼m:** `comms.webhooks` Ã¶nce oluÅŸturulmalÄ±!

---

## âœ… DoÄŸrulama Scripti

Migration'lardan sonra dependency chain'i doÄŸrulamak iÃ§in:

```sql
-- Foreign key'leri kontrol et
SELECT
  tc.table_schema,
  tc.table_name,
  kcu.column_name,
  ccu.table_schema AS foreign_table_schema,
  ccu.table_name AS foreign_table_name,
  ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
  AND tc.table_schema IN ('core', 'cfg', 'ops', 'comms', 'billing', 'app')
ORDER BY tc.table_schema, tc.table_name;
```

**Beklenen sonuÃ§:**
- Her foreign key'in target tablosu mevcut olmalÄ±
- HiÃ§bir tablo kendisinden Ã¶nce oluÅŸturulmamÄ±ÅŸ bir tabloya referans vermemeli

---

## ğŸš€ Quick Start (DoÄŸru SÄ±ralama)

```bash
# 1. Extensions, Schemas, Functions
psql $DATABASE_URL -f migrations/001_initial_schema.sql

# 2. Organizations
psql $DATABASE_URL -f migrations/002_add_organizations.sql

# 3. RBAC
psql $DATABASE_URL -f migrations/003_add_rbac.sql

# 4. Generic Data
psql $DATABASE_URL -f migrations/004_add_generic_data.sql

# 5. Microservices
psql $DATABASE_URL -f migrations/005_add_microservices.sql

# 6. File Storage
psql $DATABASE_URL -f migrations/006_add_file_storage.sql

# 7. Notifications
psql $DATABASE_URL -f migrations/007_add_notifications.sql

# 8. Webhooks
psql $DATABASE_URL -f migrations/008_add_webhooks.sql

# 9. Billing
psql $DATABASE_URL -f migrations/009_add_billing.sql

# 10. Monitoring
psql $DATABASE_URL -f migrations/010_add_monitoring.sql

# 11. Feature Flags
psql $DATABASE_URL -f migrations/011_add_feature_flags.sql

# 12. Seeds (optional)
psql $DATABASE_URL -f migrations/seeds/001_default_languages.sql
psql $DATABASE_URL -f migrations/seeds/002_default_currencies.sql
psql $DATABASE_URL -f migrations/seeds/003_platform_admin.sql
```

---

## ğŸ¯ Ã–zet

| SÄ±ra | Tablo/Schema | Neden Bu SÄ±rada? |
|------|--------------|------------------|
| 1 | Extensions | Fonksiyonlar kullanabilir (uuid-ossp, citext) |
| 2 | Schemas | Tablolar schemas iÃ§inde |
| 3 | Functions | Trigger'lar kullanacak |
| 4 | `cfg.languages` | Foreign key YOK |
| 5 | `cfg.currencies` | Foreign key YOK |
| 6 | `cfg.exchange_rates` | currencies'e baÄŸlÄ± |
| 7 | `ops.audit_logs` | Foreign key YOK (henÃ¼z) |
| 8 | `core.tenants` | languages/currencies'e baÄŸlÄ± |
| 9 | `core.users` | tenants'a baÄŸlÄ± |
| 10 | `core.user_sessions` | users'a baÄŸlÄ± |
| 11 | `core.user_2fa` | users'a baÄŸlÄ± |
| 12 | `core.projects` | tenants/users'a baÄŸlÄ± |
| 13 | `core.table_metadata` | projects'e baÄŸlÄ± |
| 14 | `app.generic_data` | table_metadata'ya baÄŸlÄ± |
| 15 | `core.api_keys` | users'a baÄŸlÄ± |
| 16 | `core.files` | users'a baÄŸlÄ± |
| 17 | `core.image_variants` | files'a baÄŸlÄ± |
| 18 | `comms.notifications` | users'a baÄŸlÄ± |
| 19 | `comms.webhooks` | tenants'a baÄŸlÄ± |
| 20 | `comms.webhook_deliveries` | webhooks'a baÄŸlÄ± |
| 21 | `billing.subscriptions` | tenants'a baÄŸlÄ± |

---

**âš ï¸ BU SIRAYI DEÄÄ°ÅTÄ°RMEYÄ°N!** Foreign key hatalarÄ± alÄ±rsÄ±nÄ±z. ğŸ”¥

[â—€ï¸ Migration Guide](README.md) | [Ana Sayfa](../README.md)


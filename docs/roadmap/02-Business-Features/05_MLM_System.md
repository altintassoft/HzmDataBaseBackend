# üå≥ MLM / Network Marketing System

> **Multi-level marketing architecture - Forever Living, Herbalife, Amway benzeri**

[‚óÄÔ∏è Geri: Job Queue System](16_Job_Queue_System.md) | [Ana Sayfa](README.md)

---

## üìã ƒ∞√ßindekiler

1. [MLM Nedir?](#mlm-nedir)
2. [Database Schema](#database-schema)
3. [Hierarchy Management](#hierarchy-management)
4. [Commission Calculation](#commission-calculation)
5. [Rank System](#rank-system)
6. [Team Performance](#team-performance)
7. [Binary vs Unilevel Plans](#binary-vs-unilevel-plans)

---

## MLM Nedir?

### MLM Business Model

```
        You (Level 0)
         /    |    \
       A      B      C    (Level 1) ‚Üí 10% commission
      / \    / \    / \
     D   E  F   G  H   I  (Level 2) ‚Üí 5% commission
    /|  /|  /|  /|  /|  /|
   ...................................  (Level 3+) ‚Üí 3%, 2%, 1%
```

**Komisyon Yapƒ±sƒ±:**
- Level 1: %10 (Direct downline)
- Level 2: %5
- Level 3: %3
- Level 4: %2
- Level 5: %1

---

## Database Schema

### 1. Distributors (Distrib√ºt√∂rler)

```sql
CREATE TABLE mlm.distributors (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INTEGER NOT NULL REFERENCES core.tenants(id),
  user_id INTEGER UNIQUE REFERENCES core.users(id),
  
  -- Sponsor (upline)
  sponsor_id INTEGER REFERENCES mlm.distributors(id),
  
  -- Hierarchy
  level INTEGER DEFAULT 0,  -- Depth in tree
  left_node INTEGER REFERENCES mlm.distributors(id),   -- Binary left
  right_node INTEGER REFERENCES mlm.distributors(id),  -- Binary right
  
  -- Rank
  current_rank VARCHAR(50) DEFAULT 'bronze',
  lifetime_rank VARCHAR(50) DEFAULT 'bronze',
  rank_qualified_at TIMESTAMPTZ,
  
  -- Stats
  personal_sales NUMERIC(12,2) DEFAULT 0,
  team_sales NUMERIC(12,2) DEFAULT 0,
  total_commission NUMERIC(12,2) DEFAULT 0,
  active_downlines INTEGER DEFAULT 0,
  
  -- Status
  is_active BOOLEAN DEFAULT TRUE,
  is_deleted BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMPTZ,
  deleted_by INTEGER,
  
  -- Audit
  version INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  created_by INTEGER,
  updated_by INTEGER
);

CREATE INDEX idx_distributors_tenant ON mlm.distributors(tenant_id);
CREATE INDEX idx_distributors_sponsor ON mlm.distributors(sponsor_id);
CREATE INDEX idx_distributors_rank ON mlm.distributors(current_rank);
CREATE INDEX idx_distributors_level ON mlm.distributors(level);

-- Triggers
CREATE TRIGGER trg_distributors_touch 
  BEFORE UPDATE ON mlm.distributors 
  FOR EACH ROW EXECUTE FUNCTION app.touch_row();
```

### 2. Hierarchy (Closure Table)

```sql
-- Closure table for efficient hierarchy queries
CREATE TABLE mlm.distributor_hierarchy (
  ancestor_id INTEGER NOT NULL REFERENCES mlm.distributors(id),
  descendant_id INTEGER NOT NULL REFERENCES mlm.distributors(id),
  depth INTEGER NOT NULL,
  path ltree,  -- Materialized path: 1.5.23.100
  
  PRIMARY KEY (ancestor_id, descendant_id),
  
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_hierarchy_ancestor ON mlm.distributor_hierarchy(ancestor_id);
CREATE INDEX idx_hierarchy_descendant ON mlm.distributor_hierarchy(descendant_id);
CREATE INDEX idx_hierarchy_depth ON mlm.distributor_hierarchy(depth);
CREATE INDEX idx_hierarchy_path ON mlm.distributor_hierarchy USING GIST (path);
```

### 3. Sales & Orders

```sql
CREATE TABLE mlm.sales (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INTEGER NOT NULL REFERENCES core.tenants(id),
  distributor_id INTEGER NOT NULL REFERENCES mlm.distributors(id),
  
  -- Sale info
  order_id INTEGER REFERENCES orders(id),
  customer_type VARCHAR(20),  -- 'retail', 'wholesale', 'distributor'
  
  -- Amounts
  subtotal NUMERIC(12,2) NOT NULL,
  bv_points NUMERIC(10,2),  -- Business Volume points
  tax NUMERIC(12,2) DEFAULT 0,
  total NUMERIC(12,2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'USD',
  
  -- Commission eligible
  is_commission_eligible BOOLEAN DEFAULT TRUE,
  commissions_paid BOOLEAN DEFAULT FALSE,
  
  -- Status
  status VARCHAR(50) DEFAULT 'pending',
  
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sales_tenant ON mlm.sales(tenant_id);
CREATE INDEX idx_sales_distributor ON mlm.sales(distributor_id);
CREATE INDEX idx_sales_created ON mlm.sales(created_at);
```

### 4. Commissions

```sql
CREATE TABLE mlm.commissions (
  id GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id INTEGER NOT NULL REFERENCES core.tenants(id),
  
  -- Who gets commission
  distributor_id INTEGER NOT NULL REFERENCES mlm.distributors(id),
  
  -- From which sale
  sale_id INTEGER NOT NULL REFERENCES mlm.sales(id),
  
  -- Commission details
  level INTEGER NOT NULL,  -- 1, 2, 3, 4, 5
  rate NUMERIC(5,4),  -- 0.1000 (10%)
  amount NUMERIC(12,2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'USD',
  
  -- Status
  status VARCHAR(50) DEFAULT 'pending',  -- pending, approved, paid, cancelled
  paid_at TIMESTAMPTZ,
  
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_commissions_tenant ON mlm.commissions(tenant_id);
CREATE INDEX idx_commissions_distributor ON mlm.commissions(distributor_id);
CREATE INDEX idx_commissions_sale ON mlm.commissions(sale_id);
CREATE INDEX idx_commissions_status ON mlm.commissions(status);
```

### 5. Ranks

```sql
CREATE TABLE mlm.ranks (
  id SERIAL PRIMARY KEY,
  tenant_id INTEGER NOT NULL REFERENCES core.tenants(id),
  
  -- Rank info
  rank_name VARCHAR(50) UNIQUE NOT NULL,
  rank_order INTEGER NOT NULL,  -- 1, 2, 3, ...
  
  -- Requirements
  requirements JSONB NOT NULL,
  
  -- Benefits
  commission_rates JSONB NOT NULL,
  bonuses JSONB,
  
  -- Display
  icon VARCHAR(100),
  color VARCHAR(7),
  
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Example ranks
INSERT INTO mlm.ranks (tenant_id, rank_name, rank_order, requirements, commission_rates) VALUES
(1, 'Bronze', 1, 
  '{"personal_sales_monthly": 0, "team_sales_monthly": 0, "active_downlines": 0}',
  '{"level1": 0.10, "level2": 0.05, "level3": 0.03, "level4": 0.02, "level5": 0.01}'),
  
(1, 'Silver', 2,
  '{"personal_sales_monthly": 1000, "team_sales_monthly": 5000, "active_downlines": 3}',
  '{"level1": 0.12, "level2": 0.06, "level3": 0.04, "level4": 0.02, "level5": 0.01}'),
  
(1, 'Gold', 3,
  '{"personal_sales_monthly": 2000, "team_sales_monthly": 15000, "active_downlines": 5}',
  '{"level1": 0.15, "level2": 0.08, "level3": 0.05, "level4": 0.03, "level5": 0.02}'),
  
(1, 'Platinum', 4,
  '{"personal_sales_monthly": 5000, "team_sales_monthly": 50000, "active_downlines": 10}',
  '{"level1": 0.20, "level2": 0.10, "level3": 0.06, "level4": 0.04, "level5": 0.02}');
```

---

## Hierarchy Management

### Add Distributor to Network

```javascript
// services/mlmService.js
class MLMService {
  /**
   * Add new distributor under sponsor
   */
  async addDistributor(tenantId, userId, sponsorId, placement = 'auto') {
    const client = await pool.connect();
    
    try {
      await client.query('BEGIN');
      
      // Get sponsor info
      const sponsor = await client.query(`
        SELECT * FROM mlm.distributors WHERE id = $1 AND tenant_id = $2
      `, [sponsorId, tenantId]);
      
      if (!sponsor.rows[0]) {
        throw new Error('Sponsor not found');
      }
      
      // Create distributor
      const result = await client.query(`
        INSERT INTO mlm.distributors (tenant_id, user_id, sponsor_id, level)
        VALUES ($1, $2, $3, $4)
        RETURNING *
      `, [tenantId, userId, sponsorId, sponsor.rows[0].level + 1]);
      
      const distributor = result.rows[0];
      
      // Build hierarchy (closure table)
      await this.buildHierarchy(client, distributor.id, sponsorId);
      
      // Place in binary tree (if binary plan)
      if (placement === 'left' || placement === 'right') {
        await this.placeBinaryNode(client, distributor.id, sponsorId, placement);
      } else {
        await this.autoPlaceBinaryNode(client, distributor.id, sponsorId);
      }
      
      await client.query('COMMIT');
      
      return distributor;
    } catch (error) {
      await client.query('ROLLBACK');
      throw error;
    } finally {
      client.release();
    }
  }
  
  /**
   * Build hierarchy (closure table)
   */
  async buildHierarchy(client, distributorId, sponsorId) {
    // Self-reference
    await client.query(`
      INSERT INTO mlm.distributor_hierarchy (ancestor_id, descendant_id, depth, path)
      VALUES ($1, $1, 0, $1::text::ltree)
    `, [distributorId]);
    
    // Copy sponsor's ancestors
    await client.query(`
      INSERT INTO mlm.distributor_hierarchy (ancestor_id, descendant_id, depth, path)
      SELECT h.ancestor_id, $1, h.depth + 1, h.path || $1::text
      FROM mlm.distributor_hierarchy h
      WHERE h.descendant_id = $2
    `, [distributorId, sponsorId]);
  }
  
  /**
   * Get downline (all descendants)
   */
  async getDownline(distributorId, maxDepth = null) {
    const query = `
      SELECT d.*, h.depth
      FROM mlm.distributors d
      JOIN mlm.distributor_hierarchy h ON d.id = h.descendant_id
      WHERE h.ancestor_id = $1
        AND h.descendant_id != $1
        ${maxDepth ? 'AND h.depth <= $2' : ''}
      ORDER BY h.depth, d.created_at
    `;
    
    const params = maxDepth ? [distributorId, maxDepth] : [distributorId];
    const result = await pool.query(query, params);
    
    return result.rows;
  }
  
  /**
   * Get upline (all ancestors)
   */
  async getUpline(distributorId) {
    const result = await pool.query(`
      SELECT d.*, h.depth
      FROM mlm.distributors d
      JOIN mlm.distributor_hierarchy h ON d.id = h.ancestor_id
      WHERE h.descendant_id = $1
        AND h.ancestor_id != $1
      ORDER BY h.depth ASC
    `, [distributorId]);
    
    return result.rows;
  }
}
```

---

## Commission Calculation

### Calculate Commissions on Sale

```javascript
/**
 * Calculate and create commissions for a sale
 */
async function calculateCommissions(tenantId, saleId) {
  const sale = await getSale(tenantId, saleId);
  const distributor = await getDistributor(tenantId, sale.distributor_id);
  
  // Get upline (max 5 levels)
  const upline = await mlmService.getUpline(distributor.id);
  
  const commissions = [];
  
  for (let i = 0; i < Math.min(upline.length, 5); i++) {
    const uplineDist = upline[i];
    const level = i + 1;
    
    // Get commission rate for this rank & level
    const rate = await getCommissionRate(uplineDist.current_rank, level);
    
    // Calculate commission amount
    const amount = sale.total * rate;
    
    // Create commission record
    commissions.push({
      tenant_id: tenantId,
      distributor_id: uplineDist.id,
      sale_id: saleId,
      level,
      rate,
      amount,
      currency: sale.currency,
      status: 'pending'
    });
  }
  
  // Bulk insert commissions
  await insertCommissions(commissions);
  
  return commissions;
}

/**
 * Get commission rate based on rank and level
 */
async function getCommissionRate(rank, level) {
  const result = await pool.query(`
    SELECT commission_rates->$2 AS rate
    FROM mlm.ranks
    WHERE rank_name = $1
  `, [rank, `level${level}`]);
  
  return parseFloat(result.rows[0]?.rate || 0);
}
```

### Pay Commissions

```javascript
/**
 * Pay pending commissions
 */
async function payCommissions(tenantId, distributorId, period) {
  const client = await pool.connect();
  
  try {
    await client.query('BEGIN');
    
    // Get pending commissions
    const result = await client.query(`
      SELECT SUM(amount) AS total, currency
      FROM mlm.commissions
      WHERE tenant_id = $1
        AND distributor_id = $2
        AND status = 'pending'
        AND created_at >= $3
        AND created_at < $4
      GROUP BY currency
    `, [tenantId, distributorId, period.start, period.end]);
    
    if (result.rows.length === 0) {
      return { paid: 0 };
    }
    
    const total = result.rows[0].total;
    const currency = result.rows[0].currency;
    
    // Create payout record
    await client.query(`
      INSERT INTO mlm.payouts (tenant_id, distributor_id, amount, currency, period_start, period_end)
      VALUES ($1, $2, $3, $4, $5, $6)
    `, [tenantId, distributorId, total, currency, period.start, period.end]);
    
    // Mark commissions as paid
    await client.query(`
      UPDATE mlm.commissions
      SET status = 'paid', paid_at = CURRENT_TIMESTAMP
      WHERE tenant_id = $1
        AND distributor_id = $2
        AND status = 'pending'
        AND created_at >= $3
        AND created_at < $4
    `, [tenantId, distributorId, period.start, period.end]);
    
    await client.query('COMMIT');
    
    return { paid: total, currency };
  } catch (error) {
    await client.query('ROLLBACK');
    throw error;
  } finally {
    client.release();
  }
}
```

---

## Rank System

### Check Rank Qualification

```javascript
/**
 * Check if distributor qualifies for rank advancement
 */
async function checkRankQualification(tenantId, distributorId) {
  const distributor = await getDistributor(tenantId, distributorId);
  const ranks = await getRanks(tenantId);
  
  // Get current performance
  const performance = await getMonthlyPerformance(tenantId, distributorId);
  
  // Check each rank (starting from highest)
  for (const rank of ranks.sort((a, b) => b.rank_order - a.rank_order)) {
    const requirements = rank.requirements;
    
    const qualified = 
      performance.personal_sales >= requirements.personal_sales_monthly &&
      performance.team_sales >= requirements.team_sales_monthly &&
      performance.active_downlines >= requirements.active_downlines;
    
    if (qualified) {
      // Advance rank
      if (distributor.current_rank !== rank.rank_name) {
        await advanceRank(tenantId, distributorId, rank.rank_name);
      }
      
      return { qualified: true, rank: rank.rank_name };
    }
  }
  
  return { qualified: false };
}

/**
 * Get monthly performance
 */
async function getMonthlyPerformance(tenantId, distributorId) {
  // Personal sales
  const personalResult = await pool.query(`
    SELECT COALESCE(SUM(total), 0) AS personal_sales
    FROM mlm.sales
    WHERE tenant_id = $1
      AND distributor_id = $2
      AND created_at >= DATE_TRUNC('month', CURRENT_DATE)
      AND status = 'completed'
  `, [tenantId, distributorId]);
  
  // Team sales
  const teamResult = await pool.query(`
    SELECT COALESCE(SUM(s.total), 0) AS team_sales
    FROM mlm.sales s
    JOIN mlm.distributor_hierarchy h ON s.distributor_id = h.descendant_id
    WHERE s.tenant_id = $1
      AND h.ancestor_id = $2
      AND h.descendant_id != $2
      AND s.created_at >= DATE_TRUNC('month', CURRENT_DATE)
      AND s.status = 'completed'
  `, [tenantId, distributorId]);
  
  // Active downlines
  const downlineResult = await pool.query(`
    SELECT COUNT(DISTINCT h.descendant_id) AS active_downlines
    FROM mlm.distributor_hierarchy h
    JOIN mlm.sales s ON h.descendant_id = s.distributor_id
    WHERE h.ancestor_id = $1
      AND h.depth = 1
      AND s.created_at >= DATE_TRUNC('month', CURRENT_DATE)
      AND s.status = 'completed'
  `, [distributorId]);
  
  return {
    personal_sales: parseFloat(personalResult.rows[0].personal_sales),
    team_sales: parseFloat(teamResult.rows[0].team_sales),
    active_downlines: parseInt(downlineResult.rows[0].active_downlines)
  };
}
```

---

## Team Performance

### Team Performance Report

```sql
CREATE MATERIALIZED VIEW mlm.team_performance AS
SELECT 
  d.id AS distributor_id,
  d.tenant_id,
  d.current_rank,
  
  -- Personal stats
  COUNT(DISTINCT CASE WHEN s.distributor_id = d.id THEN s.id END) AS personal_orders,
  COALESCE(SUM(CASE WHEN s.distributor_id = d.id THEN s.total END), 0) AS personal_sales,
  
  -- Team stats (downline)
  COUNT(DISTINCT h.descendant_id) - 1 AS team_size,
  COUNT(DISTINCT CASE WHEN h.depth = 1 THEN h.descendant_id END) AS direct_downlines,
  COUNT(DISTINCT CASE WHEN s2.id IS NOT NULL THEN h.descendant_id END) AS active_team_members,
  COALESCE(SUM(CASE WHEN h.descendant_id != d.id THEN s2.total END), 0) AS team_sales,
  
  -- Commission stats
  COALESCE(SUM(c.amount), 0) AS total_commissions
  
FROM mlm.distributors d
LEFT JOIN mlm.distributor_hierarchy h ON d.id = h.ancestor_id
LEFT JOIN mlm.sales s ON d.tenant_id = s.tenant_id 
  AND s.created_at >= CURRENT_DATE - INTERVAL '30 days'
LEFT JOIN mlm.sales s2 ON h.descendant_id = s2.distributor_id 
  AND s2.created_at >= CURRENT_DATE - INTERVAL '30 days'
LEFT JOIN mlm.commissions c ON d.id = c.distributor_id 
  AND c.created_at >= CURRENT_DATE - INTERVAL '30 days'
WHERE d.is_deleted = FALSE
GROUP BY d.id, d.tenant_id, d.current_rank;

CREATE UNIQUE INDEX idx_team_perf_pk ON mlm.team_performance (tenant_id, distributor_id);
```

---

## Binary vs Unilevel Plans

### Unilevel Plan (Unlimited Width)

```
        You
     /  |  |  \
    A   B  C   D   (All direct)
   /|   |  |\   \
  E F   G  H I   J
```

**Characteristics:**
- Unlimited direct downlines
- Commissions on unlimited depth
- Easier to build
- Lower compression

### Binary Plan (2 Legs Only)

```
       You
      /    \
     A      B
    / \    / \
   C   D  E   F
```

**Characteristics:**
- Max 2 direct downlines
- Spillover to downline
- Balanced tree growth
- Team building focused

---

## Best Practices

### ‚úÖ DO

1. **Use closure table** - Fast hierarchy queries
2. **Calculate commissions async** - Background job
3. **Materialized views** - Team performance
4. **Rank checks monthly** - Scheduled job
5. **Audit all transactions** - Commission history
6. **Cap commission levels** - Max 5-7 levels
7. **Set min qualifications** - Prevent gaming

### ‚ùå DON'T

1. **Don't query recursively** - Use closure table!
2. **Don't calculate real-time** - Too slow
3. **Don't allow circular** - Parent ‚Üí child ‚Üí parent
4. **Don't forget compliance** - Legal requirements
5. **Don't skip audits** - Commission disputes

---

## üîó ƒ∞lgili D√∂k√ºmanlar

- [05_Template_System.md](05_Template_System.md) - MLM template
- [06_Business_Logic_Modules.md](06_Business_Logic_Modules.md) - Commission logic
- [14_Reports_Analytics.md](14_Reports_Analytics.md) - Performance reports

---

**Versiyon:** 1.0.0  
**Tarih:** Ekim 2025  
**Yazar:** HZM Development Team

---

**[‚óÄÔ∏è Geri: Job Queue System](16_Job_Queue_System.md) | [Ana Sayfa](README.md)**

